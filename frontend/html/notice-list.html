<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µì§€ì‚¬í•­</title>
    <link rel="stylesheet" th:href="@{/css/user-notice.css(v=${#dates.format(#dates.createNow(), 'yyyyMMddHHmmss')})}">
</head>
<body>
    <div class="notice-container">
        <div class="notice-list-header">
            <img src="/images/Logo.png" alt="ë¡œê³ " class="notice-logo" onclick="goToMainPage()" style="cursor: pointer;" />
            <h2 class="notice-title">ê³µì§€ì‚¬í•­</h2>
        </div>

        <div class="search-container">
            <div class="search-input-wrapper">
                <input type="text" id="searchInput" placeholder="ì œëª© ë˜ëŠ” ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰..." class="search-input" />
                <span class="search-icon" onclick="performSearch()">ğŸ”</span>
            </div>
        </div>

        <table class="notice-table">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>ì œëª©</th>
                    <th>ì´ë¦„</th>
                    <th>ì¡°íšŒìˆ˜</th>
                    <th>ë“±ë¡ì¼</th>
                </tr>
            </thead>
            <tbody id="noticeTableBody">
                <tr>
                    <td colspan="5">ë¡œë”© ì¤‘...</td>
                </tr>
            </tbody>
        </table>

        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        let notices = [];
        let filteredNotices = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        async function fetchNotices() {
            try {
                const response = await fetch('/api/user/notices');
                notices = await response.json();
                filteredNotices = notices;
                renderNotices();
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', error);
                document.getElementById('noticeTableBody').innerHTML = 
                    '<tr><td colspan="5">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        function renderNotices() {
            const tbody = document.getElementById('noticeTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageNotices = filteredNotices.slice(startIndex, endIndex);
            const visitedNotices = getVisitedNotices();

            if (pageNotices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = pageNotices.map(notice => {
                const isVisited = visitedNotices.includes(notice.id.toString());
                const rowClass = isVisited ? 'notice-row-visited' : '';
                const titleColor = isVisited ? '#6c757d' : '#007bff';
                
                return `
                    <tr class="${rowClass}">
                        <td><span class="notice-badge">ê³µì§€</span></td>
                        <td class="notice-subject" onclick="viewNotice(${notice.id})" style="cursor: pointer; color: ${titleColor};">
                            ${notice.title}
                        </td>
                        <td>ê´€ë¦¬ì</td>
                        <td>${notice.viewCount || 0}</td>
                        <td>${new Date(notice.createdAt).toLocaleDateString('ko-KR')}</td>
                    </tr>
                `;
            }).join('');

            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredNotices.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = `
                <button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="pagination-btn">ì´ì „</button>
                <div class="pagination-pages">
            `;

            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="goToPage(${i})" class="pagination-page ${currentPage === i ? 'active' : ''}">${i}</button>`;
            }

            html += `
                </div>
                <button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="pagination-btn">ë‹¤ìŒ</button>
            `;

            pagination.innerHTML = html;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredNotices.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                localStorage.setItem('currentNoticePage', currentPage);
                renderNotices();
            }
        }

        function getVisitedNotices() {
            const visited = localStorage.getItem('visitedNotices');
            return visited ? JSON.parse(visited) : [];
        }

        function addVisitedNotice(id) {
            const visited = getVisitedNotices();
            if (!visited.includes(id.toString())) {
                visited.push(id.toString());
                localStorage.setItem('visitedNotices', JSON.stringify(visited));
            }
        }

        async function viewNotice(id) {
            try {
                // í˜„ì¬ í˜ì´ì§€ ì •ë³´ ì €ì¥
                localStorage.setItem('currentNoticePage', currentPage);
                addVisitedNotice(id);
                await fetch(`/api/user/notices/hit/${id}`);
                window.location.href = `/notice/${id}`;
            } catch (error) {
                console.error('ì¡°íšŒìˆ˜ ì¦ê°€ ì‹¤íŒ¨:', error);
                localStorage.setItem('currentNoticePage', currentPage);
                addVisitedNotice(id);
                window.location.href = `/notice/${id}`;
            }
        }

        function performSearch() {
            const searchIcon = document.querySelector('.search-icon');
            const noticeTable = document.querySelector('.notice-table');
            const noticeContainer = document.querySelector('.notice-container');
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            
            // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            searchIcon.classList.add('loading');
            noticeTable.classList.add('loading');
            noticeContainer.classList.add('loading-overlay');
            
            // 1ì´ˆ í›„ ê²€ìƒ‰ ì‹¤í–‰
            setTimeout(() => {
                filteredNotices = notices.filter(notice =>
                    notice.title.toLowerCase().includes(keyword) ||
                    notice.content.toLowerCase().includes(keyword)
                );
                currentPage = 1;
                renderNotices();
                
                // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ
                searchIcon.classList.remove('loading');
                noticeTable.classList.remove('loading');
                noticeContainer.classList.remove('loading-overlay');
            }, 1000);
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            filteredNotices = notices.filter(notice =>
                notice.title.toLowerCase().includes(keyword) ||
                notice.content.toLowerCase().includes(keyword)
            );
            currentPage = 1;
            renderNotices();
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ í˜ì´ì§€ë¡œ ì´ë™
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const pageParam = urlParams.get('page');
            if (pageParam) {
                currentPage = parseInt(pageParam);
            } else {
                const savedPage = localStorage.getItem('currentNoticePage');
                if (savedPage) {
                    currentPage = parseInt(savedPage);
                }
            }
        });
        
        function goToMainPage() {
            // í˜ì´ì§€ë„¤ì´ì…˜ì„ 1ë¡œ ì´ˆê¸°í™”í•˜ê³  ë©”ì¸í˜ì´ì§€ë¡œ ì´ë™
            localStorage.setItem('currentNoticePage', '1');
            currentPage = 1;
            renderNotices();
        }
        
        fetchNotices();
    </script>
</body>
</html>
