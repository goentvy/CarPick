<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>카픽 - 고객관리</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/common.css}">
    <link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
    <link rel="stylesheet" th:href="@{/assets/css/metisMenu.css}">
    <link rel="stylesheet" th:href="@{/assets/css/typography.css}">
    <link rel="stylesheet" th:href="@{/assets/css/default-css.css}">
    <link rel="stylesheet" th:href="@{/assets/css/styles.css}">
    <link rel="stylesheet" th:href="@{/assets/css/responsive.css}">
    <style>
        .sidebar-menu {
            overflow-y: hidden !important;
        }
    </style>
</head>

<body>
<div class="page-container">

    <!-- 사이드바 -->
    <div th:replace="~{fragments/fragments :: sidebar}"></div>

    <!-- 헤더 -->
    <div th:replace="~{fragments/fragments :: header}"></div>

    <!-- 본문 -->
    <div class="main-content">
        <!-- 타이틀 -->
        <div class="page-title-area">
            <div class="row align-items-center">
                <div class="col-sm-6">
                    <div class="breadcrumbs-area clearfix">
                        <h4 class="page-title pull-left">고객 관리</h4>
                        <ul class="breadcrumbs pull-left">
                            <li><a href="/admin">홈</a></li>
                            <li><span>고객 관리</span></li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-6 clearfix">
                    <a href="/admin/user/write" class="btn btn-primary pull-right">
                        고객 등록
                    </a>
                </div>
            </div>
        </div>

        <!-- 검색 -->
        <div class="main-content-inner">
            <form method="get" action="/admin/user">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text"
                               class="form-control"
                               name="search"
                               placeholder="이메일 / 이름 / 휴대폰 검색"
                               th:value="${search}">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-light">
                            <i class="ti-search"></i> 검색
                        </button>
                    </div>
                </div>
            </form>

            <!-- 테이블 -->
            <div class="card">
                <div class="card-body">
                    <h4 class="header-title">고객 목록</h4>

                    <div class="table-responsive">
                        <table class="table table-hover text-center">
                            <thead class="text-uppercase">
                            <tr>
                                <th>NO</th>
                                <th>이메일</th>
                                <th>이름</th>
                                <th>휴대폰</th>
                                <th>멤버쉽</th>
                                <th>가입일</th>
                                <th>관리</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="user, stat : ${userList}">
                                <td th:text="${totalCount - ((page - 1) * size) - stat.index}"></td>

                                <td>
                                    <a th:href="@{/admin/user/edit(id=${user.id})}"
                                       th:text="${user.email}">
                                    </a>
                                </td>

                                <td th:text="${user.name}"></td>
                                <td th:text="${user.phone}"></td>

                                <!-- 멤버쉽 등급 -->
                                <td>
                                    <span class="badge"
                                          th:classappend="${user.membershipGrade == 'VIP'} ? 'badge-danger' : 'badge-secondary'"
                                          th:text="${user.membershipGrade}">
                                    </span>
                                </td>

                                <td th:text="${#temporals.format(user.createdAt, 'yyyy-MM-dd')}"></td>

                                <td>
                                    <!-- 수정 -->
                                    <a th:href="@{/admin/user/edit(id=${user.id})}"
                                       class="btn btn-sm btn-info">
                                        수정
                                    </a>

                                    <!-- 삭제 -->
                                    <button type="button"
                                            class="btn btn-sm btn-danger"
                                            th:onclick="|deleteUser(${user.id})|">
                                        <i class="ti-trash"></i>
                                    </button>
                                </td>
                            </tr>

                            <tr th:if="${#lists.isEmpty(userList)}">
                                <td colspan="7">조회된 고객이 없습니다.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 페이징 -->
            <nav class="mt-4">
                <ul class="pagination justify-content-center">

                    <!-- 이전 -->
                    <li class="page-item" th:classappend="${page == 1} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/admin/user(page=${page-1}, search=${search})}">
                            Previous
                        </a>
                    </li>

                    <!-- 페이지 번호 -->
                    <li class="page-item"
                        th:each="p : ${#numbers.sequence(1, (totalCount + size - 1) / size)}"
                        th:classappend="${p == page} ? 'active'">
                        <a class="page-link"
                           th:href="@{/admin/user(page=${p}, search=${search})}"
                           th:text="${p}">
                        </a>
                    </li>

                    <!-- 다음 -->
                    <li class="page-item"
                        th:classappend="${page * size >= totalCount} ? 'disabled'">
                        <a class="page-link"
                           th:href="@{/admin/user(page=${page+1}, search=${search})}">
                            Next
                        </a>
                    </li>

                </ul>
            </nav>

        </div>

        <!-- 푸터 -->
        <div th:replace="~{fragments/fragments :: footer}"></div>
    </div>
</div>

<!-- JS -->
<script th:src="@{/assets/js/vendor/jquery-2.2.4.min.js}"></script>
<script th:src="@{/assets/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/metisMenu.min.js}"></script>
<script th:src="@{/assets/js/plugins.js}"></script>
<script th:src="@{/assets/js/scripts.js}"></script>

<script>
    function deleteUser(id) {
        if (!confirm('정말 삭제하시겠습니까?')) return;

        const formData = new URLSearchParams();
        formData.append('id', id);

        fetch('/admin/user/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: formData.toString()
        }).then(() => location.reload());
    }
</script>

</body>
</html>
