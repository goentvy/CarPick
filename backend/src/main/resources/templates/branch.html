<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ì¹´í”½ - ì§€ì  ê´€ë¦¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- CSS -->
    <link rel="shortcut icon" type="image/png" href="assets/images/icon/favicon.ico">
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/common.css}">
    <link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
    <link rel="stylesheet" th:href="@{/assets/css/metisMenu.css}">
    <link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/slicknav.min.css}">

    <!-- amchart css (CDN) -->
    <link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />

    <!-- Others CSS -->
    <link rel="stylesheet" th:href="@{/assets/css/typography.css}">
    <link rel="stylesheet" th:href="@{/assets/css/default-css.css}">
    <link rel="stylesheet" th:href="@{/assets/css/styles.css}">
    <link rel="stylesheet" th:href="@{/assets/css/responsive.css}">

    <!-- JS -->
    <script th:src="@{/assets/js/vendor/modernizr-2.8.3.min.js}"></script>


    <style>
        .branch-input {
            width: 100%;
            font-size: 0.85rem;
        }
        .branch-input-sm {
            width: 80px;
        }
        .branch-actions button {
            margin-right: 4px;
        }
        .table td, .table th {
            vertical-align: middle !important;
        }
    </style>
</head>

<body>

<div class="page-container">

    <!-- ì‚¬ì´ë“œë°” -->
    <div th:replace="fragments/fragments :: sidebar"></div>

    <!-- í—¤ë” -->
    <div th:replace="fragments/fragments :: header"></div>

    <!-- ë³¸ë¬¸ -->
    <div class="main-content">
        <div class="page-title-area">
            <div class="row align-items-center">
                <div class="col-sm-6">
                    <div class="breadcrumbs-area clearfix">
                        <h4 class="page-title pull-left">ì§€ì  ê´€ë¦¬</h4>
                        <ul class="breadcrumbs pull-left">
                            <li><a href="/admin">í™ˆ</a></li>
                            <li><span>ì§€ì  ê´€ë¦¬</span></li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-6 clearfix">
                    <button type="button"
                            class="user-profile user_writeBtn pull-right"
                            onclick="addEmptyRow()">
                        ì§€ì  ì¶”ê°€
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content-inner">
            <div class="row">
                <div class="col-lg-12 mt-3">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="header-title">ì§€ì  ëª©ë¡</h4>
                            <p class="text-muted" style="font-size: 0.85rem;">
                                Â· ì§€ì  ì½”ë“œ/ì´ë¦„/ì£¼ì†Œ/ì „í™”ë²ˆí˜¸/ì˜ì—…ì‹œê°„ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.<br>
                                Â· í–‰ì—ì„œ ë°”ë¡œ ìˆ˜ì • í›„ <strong>ì €ì¥</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
                            </p>
                            <div class="single-table">
                                <div class="table-responsive">
                                    <table class="table text-center">
                                        <thead class="text-uppercase">
                                        <tr>
                                            <th style="width: 50px;">NO</th>
                                            <th style="width: 100px;">ì§€ì ì½”ë“œ</th>
                                            <th style="width: 120px;">ì§€ì ëª…</th>
                                            <th>ì£¼ì†Œ</th>
                                            <th style="width: 130px;">ì „í™”ë²ˆí˜¸</th>
                                            <th style="width: 80px;">ì˜¤í”ˆ</th>
                                            <th style="width: 80px;">ë§ˆê°</th>
                                            <th style="width: 80px;">ì§€ì—­</th>
                                            <th style="width: 140px;">ìµœì¢…ìˆ˜ì •ì¼</th>
                                            <th style="width: 120px;">ê´€ë¦¬</th>
                                        </tr>
                                        </thead>
                                        <tbody id="branch-table-body">
                                        <!-- JSë¡œ ë™ì  ë Œë”ë§ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="mt-2">
                                <span class="badge badge-info">TIP</span>
                                <span style="font-size: 0.8rem;">
                                    ì§€ì ì— ë“±ë¡ëœ ì°¨ëŸ‰ ì¬ê³ ê°€ ìˆìœ¼ë©´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¬ê³ ë¥¼ ë¨¼ì € ì´ë™í•˜ê±°ë‚˜ ì‚­ì œí•´ ì£¼ì„¸ìš”.
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í‘¸í„° -->
    <div th:replace="fragments/fragments :: footer"></div>

</div>

<!-- JS -->
<script th:src="@{/assets/js/vendor/jquery-2.2.4.min.js}"></script>
<script th:src="@{/assets/js/popper.min.js}"></script>
<script th:src="@{/assets/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/owl.carousel.min.js}"></script>
<script th:src="@{/assets/js/metisMenu.min.js}"></script>
<script th:src="@{/assets/js/jquery.slimscroll.min.js}"></script>
<script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>
<script th:src="@{/assets/js/plugins.js}"></script>
<script th:src="@{/assets/js/scripts.js}"></script>

<script>
    // ================================
    //  ì§€ì  ëª©ë¡ ë¡œë”©
    // ================================
    $(document).ready(function () {
        loadBranches();
    });

    function loadBranches() {
        $.ajax({
            url: '/admin/api/branch',
            method: 'GET',
            success: function (data) {
                renderTable(data);
            },
            error: function (xhr) {
                console.error(xhr);
                alert('ì§€ì  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }

    function renderTable(list) {
        const $tbody = $('#branch-table-body');
        $tbody.empty();

        if (!list || list.length === 0) {
            $tbody.append('<tr><td colspan="10">ë“±ë¡ëœ ì§€ì ì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ [ì§€ì  ì¶”ê°€] ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ì§€ì ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</td></tr>');
            return;
        }

        list.forEach(function (branch, index) {
            const rowHtml = createRowHtml(branch, index + 1);
            $tbody.append(rowHtml);
        });
    }

    function createRowHtml(branch, no) {
        const id = branch.branchId || '';
        const code = branch.branchCode || '';
        const name = branch.branchName || '';
        const addrBasic = branch.addressBasic || '';
        const addrDetail = branch.addressDetail || '';
        const phone = branch.phone || '';
        const openTime = branch.openTime || '';
        const closeTime = branch.closeTime || '';
        const region = branch.regionDept1 || '';
        const updatedAt = branch.updatedAt || '';

        // ì£¼ì†ŒëŠ” ê¸°ë³¸ + ìƒì„¸ í•©ì³ì„œ í‘œì‹œ
        const fullAddr = addrDetail ? addrBasic + ' ' + addrDetail : addrBasic;

        return `
            <tr data-id="${id}">
                <th scope="row">${no}</th>
                <td>
                    <input type="text" class="form-control form-control-sm branch-input"
                           data-field="branchCode"
                           value="${escapeHtml(code)}" placeholder="ì˜ˆ) BR001">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm branch-input"
                           data-field="branchName"
                           value="${escapeHtml(name)}" placeholder="ì§€ì ëª…">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm branch-input"
                           data-field="addressBasic"
                           value="${escapeHtml(addrBasic)}" placeholder="ì£¼ì†Œ">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm branch-input"
                           data-field="phone"
                           value="${escapeHtml(phone)}" placeholder="010-0000-0000">
                </td>
                <td>
                    <input type="time" class="form-control form-control-sm branch-input-sm"
                           data-field="openTime"
                           value="${openTime}">
                </td>
                <td>
                    <input type="time" class="form-control form-control-sm branch-input-sm"
                           data-field="closeTime"
                           value="${closeTime}">
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm branch-input"
                           data-field="regionDept1"
                           value="${escapeHtml(region)}" placeholder="ì„œìš¸">
                </td>
                <td style="font-size:0.8rem;">${updatedAt}</td>
                <td class="branch-actions">
                    <button type="button" class="btn btn-sm btn-primary" onclick="saveRow(this)">ì €ì¥</button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteRow(this)">ì‚­ì œ</button>
                </td>
            </tr>
        `;
    }

    // ================================
    //  ì§€ì  ì¶”ê°€ (ë¹ˆ í–‰)
    // ================================
    function addEmptyRow() {
        const $tbody = $('#branch-table-body');
        // ğŸ” í•µì‹¬ ìˆ˜ì •: "ë“±ë¡ëœ ì§€ì ì´ ì—†ìŠµë‹ˆë‹¤" ì•ˆë‚´ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì§€ìš´ë‹¤!
        // (í–‰ì´ 1ê°œì¸ë° ê·¸ ì•ˆì— colspan(ë³‘í•©)ëœ ì¹¸ì´ ìˆë‹¤ë©´ ì•ˆë‚´ ë¬¸êµ¬ë¡œ ê°„ì£¼)
        if ($tbody.children('tr').length === 1 && $tbody.find('td[colspan]').length > 0) {
            $tbody.empty();
        }
        const no = $tbody.children('tr').length + 1;

        const empty = {
            branchId: null,
            branchCode: '',
            branchName: '',
            addressBasic: '',
            addressDetail: '',
            phone: '',
            openTime: '',
            closeTime: '',
            regionDept1: '',
            updatedAt: ''
        };
        const rowHtml = createRowHtml(empty, no);
        $tbody.append(rowHtml);
    }

    // ================================
    //  ì €ì¥ (ì‹ ê·œ/ìˆ˜ì • ê³µí†µ)
    // ================================
    function saveRow(btn) {
        const $tr = $(btn).closest('tr');
        const id = $tr.data('id');

        const payload = {
            branchCode: $tr.find('[data-field="branchCode"]').val(),
            branchName: $tr.find('[data-field="branchName"]').val(),
            addressBasic: $tr.find('[data-field="addressBasic"]').val(),
            phone: $tr.find('[data-field="phone"]').val(),
            openTime: $tr.find('[data-field="openTime"]').val() || null,
            closeTime: $tr.find('[data-field="closeTime"]').val() || null,
            regionDept1: $tr.find('[data-field="regionDept1"]').val()
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? '/admin/api/branch/' + id : '/admin/api/branch';

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (res) {
                const msg = res && res.message ? res.message : 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                alert(msg);
                loadBranches();
            },
            error: function (xhr) {
                console.error(xhr);
                let msg = 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    msg = xhr.responseJSON.message;
                }
                alert(msg);
            }
        });
    }

    // ================================
    //  ì‚­ì œ
    // ================================
    function deleteRow(btn) {
        const $tr = $(btn).closest('tr');
        const id = $tr.data('id');

        if (!id) {
            $tr.remove();
            return;
        }

        if (!confirm('í•´ë‹¹ ì§€ì ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        $.ajax({
            url: '/admin/api/branch/' + id,
            method: 'DELETE',
            success: function (res) {
                const msg = res && res.message ? res.message : 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
                alert(msg);
                loadBranches();
            },
            error: function (xhr) {
                console.error(xhr);
                let msg = 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    msg = xhr.responseJSON.message;
                }
                alert(msg);
            }
        });
    }

    // ================================
    //  HTML ì´ìŠ¤ì¼€ì´í”„
    // ================================
    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }
</script>

</body>
</html>