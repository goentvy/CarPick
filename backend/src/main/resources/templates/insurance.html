<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>카픽 - 보험 옵션 관리</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" type="image/png" th:href="@{/assets/images/icon/favicon.ico}">
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/common.css}">
    <link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
    <link rel="stylesheet" th:href="@{/assets/css/metisMenu.css}">
    <link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/slicknav.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/typography.css}">
    <link rel="stylesheet" th:href="@{/assets/css/default-css.css}">
    <link rel="stylesheet" th:href="@{/assets/css/styles.css}">
    <link rel="stylesheet" th:href="@{/assets/css/responsive.css}">
    <script th:src="@{/assets/js/vendor/modernizr-2.8.3.min.js}"></script>

    <style>
        /* 편집 모드 스타일 */
        .edit-input {
            display: none;
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn-save,
        .btn-cancel {
            display: none;
        }

        .editing .view-text {
            display: none;
        }

        .editing .edit-input {
            display: block;
        }

        .editing .btn-edit {
            display: none;
        }

        .editing .btn-save,
        .editing .btn-cancel {
            display: inline-block;
        }

        .table th,
        .table td {
            vertical-align: middle;
            text-align: center;
            font-size: 14px;
        }

        select.edit-input {
            height: 35px;
        }
    </style>
</head>

<body>
<div class="page-container">
    <div class="sidebar-menu" th:replace="fragments/fragments :: sidebar"></div>

    <div class="main-content">
        <div class="page-title-area">
            <div class="row align-items-center">
                <div class="col-sm-6">
                    <div class="breadcrumbs-area clearfix">
                        <h4 class="page-title pull-left">보험 옵션 관리</h4>
                        <ul class="breadcrumbs pull-left">
                            <li><a href="/admin">Home</a></li>
                            <li><span>보험 관리</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content-inner">
            <div class="row">
                <div class="col-12 mt-5">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="header-title mb-0">렌터카 보험 목록</h4>
                            </div>

                            <div class="single-table">
                                <div class="table-responsive">
                                    <table class="table table-hover progress-table text-center">
                                        <thead class="text-uppercase bg-light">
                                        <tr>
                                            <th>ID</th>
                                            <th style="width: 15%;">코드</th>
                                            <th style="width: 15%;">보험명</th>
                                            <th>설명 (요약)</th>
                                            <th style="width: 10%;">가격</th>
                                            <th style="width: 8%;">기본</th>
                                            <th style="width: 8%;">활성</th>
                                            <th style="width: 8%;">순서</th>
                                            <th style="width: 12%;">관리</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="item : ${list}" th:id="'row-' + ${item.insuranceId}">
                                            <td th:text="${item.insuranceId}">1</td>

                                            <td>
                                                <span class="view-text badge badge-primary" th:text="${item.insuranceCode}">CODE</span>
                                                <select class="edit-input" name="insuranceCode" disabled style="background-color: #e9ecef;">
                                                    <option value="NONE" th:selected="${item.insuranceCode.toString() == 'NONE'}">NONE (전액부담)</option>
                                                    <option value="STANDARD" th:selected="${item.insuranceCode.toString() == 'STANDARD'}">STANDARD (30만원)</option>
                                                    <option value="FULL" th:selected="${item.insuranceCode.toString() == 'FULL'}">FULL (면제)</option>
                                                </select>
                                            </td>

                                            <td>
                                                <span class="view-text" th:text="${item.insuranceLabel}">자차</span>
                                                <input type="text" class="edit-input" name="insuranceLabel" th:value="${item.insuranceLabel}">
                                            </td>

                                            <td>
                                                <span class="view-text" th:text="${item.summaryLabel}">설명</span>
                                                <input type="text" class="edit-input" name="summaryLabel" th:value="${item.summaryLabel}">
                                            </td>

                                            <td>
                                                <span class="view-text"
                                                      th:text="${#numbers.formatInteger(item.extraDailyPrice, 0, 'COMMA')}">0</span>
                                                <input type="number" class="edit-input" name="extraDailyPrice"
                                                       th:value="${item.extraDailyPrice}">
                                            </td>

                                            <td>
                                                <span class="view-text badge"
                                                      th:classappend="${item.isDefault} ? 'badge-success' : 'badge-secondary'"
                                                      th:text="${item.isDefault} ? 'Y' : 'N'">N</span>
                                                <select class="edit-input" name="isDefault">
                                                    <option value="true" th:selected="${item.isDefault == true}">Y</option>
                                                    <option value="false" th:selected="${item.isDefault == false}">N</option>
                                                </select>
                                            </td>

                                            <td>
                                                <span class="view-text badge"
                                                      th:classappend="${item.isActive} ? 'badge-info' : 'badge-light'"
                                                      th:text="${item.isActive} ? 'ON' : 'OFF'">ON</span>
                                                <select class="edit-input" name="isActive">
                                                    <option value="true" th:selected="${item.isActive == true}">ON</option>
                                                    <option value="false" th:selected="${item.isActive == false}">OFF</option>
                                                </select>
                                            </td>

                                            <td>
                                                <span class="view-text" th:text="${item.sortOrder}">0</span>
                                                <input type="number" class="edit-input" name="sortOrder" th:value="${item.sortOrder}">
                                            </td>

                                            <td>
                                                <ul class="d-flex justify-content-center">
                                                    <li class="mr-2 btn-edit">
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                                th:onclick="'enableEdit(' + ${item.insuranceId} + ')'"
                                                                title="수정">
                                                            <i class="fa fa-edit"></i>
                                                        </button>
                                                    </li>
                                                    <li class="mr-2 btn-save">
                                                        <button class="btn btn-sm btn-success"
                                                                th:onclick="'saveRow(' + ${item.insuranceId} + ')'"
                                                                title="저장">
                                                            <i class="fa fa-check"></i>
                                                        </button>
                                                    </li>
                                                    <li class="btn-cancel">
                                                        <button class="btn btn-sm btn-secondary"
                                                                th:onclick="'cancelEdit(' + ${item.insuranceId} + ')'"
                                                                title="취소">
                                                            <i class="fa fa-times"></i>
                                                        </button>
                                                    </li>
                                                </ul>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="mt-3">
                                <div class="alert alert-info mb-0">
                                    <i class="fa fa-lightbulb-o"></i>
                                    <strong>안내:</strong> 보험 종류는 고정입니다. 사용하지 않는 보험은 <strong>활성(OFF)</strong> 상태로 변경해 주세요.
                                </div>
                            </div>

                        </div> </div> </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="footer-area">
            <p>© 2025 CarPick Admin.</p>
        </div>
    </footer>
</div>

<script th:src="@{/assets/js/vendor/jquery-2.2.4.min.js}"></script>
<script th:src="@{/assets/js/popper.min.js}"></script>
<script th:src="@{/assets/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/metisMenu.min.js}"></script>
<script th:src="@{/assets/js/jquery.slimscroll.min.js}"></script>
<script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>
<script th:src="@{/assets/js/scripts.js}"></script>

<script>
    // 1. [수정 모드] 전환
    function enableEdit(id) {
        document.getElementById('row-' + id).classList.add('editing');
    }

    // 2. [수정 모드] 취소
    function cancelEdit(id) {
        location.reload();
    }

    // 3. [수정] 데이터 저장 (PUT)
    function saveRow(id) {
        const row = document.getElementById('row-' + id);

        // [수정됨] name="insuranceLabel" 값을 가져오도록 변경
        const insuranceLabelVal = row.querySelector('[name=insuranceLabel]').value;

        const data = {
            insuranceId: id,
            insuranceCode: row.querySelector('[name=insuranceCode]').value,
            insuranceLabel: insuranceLabelVal, // label -> insuranceLabel
            summaryLabel: row.querySelector('[name=summaryLabel]').value,
            isDefault: row.querySelector('[name=isDefault]').value === 'true',
            isActive: row.querySelector('[name=isActive]').value === 'true',
            extraDailyPrice: parseInt(row.querySelector('[name=extraDailyPrice]').value) || 0,
            sortOrder: parseInt(row.querySelector('[name=sortOrder]').value) || 0
        };

        // [수정됨] 유효성 검사 키값 변경
        if (!data.insuranceLabel) {
            alert('보험명은 필수 입력 항목입니다.');
            return;
        }

        fetch('/admin/api/insurance/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('수정 실패: ' + result.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('서버 통신 오류');
            });
    }
</script>
</body>
</html>