<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>카픽 - 기본 할인 관리</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS (기존 관리자 템플릿 그대로) -->
    <link rel="shortcut icon" type="image/png" href="assets/images/icon/favicon.ico">
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/common.css}">
    <link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
    <link rel="stylesheet" th:href="@{/assets/css/metisMenu.css}">
    <link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/slicknav.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/typography.css}">
    <link rel="stylesheet" th:href="@{/assets/css/default-css.css}">
    <link rel="stylesheet" th:href="@{/assets/css/styles.css}">
    <link rel="stylesheet" th:href="@{/assets/css/responsive.css}">

    <script th:src="@{/assets/js/vendor/modernizr-2.8.3.min.js}"></script>

    <style>
        .inline-input { width: 90px; height: 32px; padding: 0 8px; }
        .badge-mode { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; background: #f1f5f9; border: 1px solid #e2e8f0; }
        .row-disabled { opacity: 0.45; }
        .hint-text { font-size: 12px; color: #64748b; }
        .table td, .table th { vertical-align: middle !important; }
    </style>
</head>

<body>
<div class="page-container">

    <!-- ✅ 여기만 변경: 사이드바를 fragments로 교체 -->
    <div th:replace="fragments/fragments :: sidebar"></div>

    <!-- 메인 컨텐츠 (기존 그대로 유지) -->
    <div class="main-content">
        <!-- 상단 헤더 (기존 그대로 유지) -->
        <div class="header-area">
            <div class="row align-items-center">
                <div class="col-md-6 col-sm-8 clearfix">
                    <div class="nav-btn pull-left">
                        <span></span><span></span><span></span>
                    </div>
                    <div class="breadcrumb-area clearfix">
                        <ul class="breadcrumb">
                            <li><span>기본 할인 관리</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 페이지 본문 -->
        <div class="main-content-inner">
            <div class="row">
                <div class="col-12 mt-4">
                    <div class="card">
                        <div class="card-body">

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h4 class="header-title mb-1">기본 할인 관리</h4>
                                    <p class="hint-text mb-0">
                                        * 실제 결제 금액을 변경하지 않는 “표시용(프로모션) 할인율” 관리 페이지입니다.<br/>
                                        * <b>지점 전체 적용</b>과 <b>차종별 적용</b>은 동시에 활성화될 수 없도록 배타 처리됩니다.
                                    </p>
                                </div>
                                <div>
                                    <span class="badge-mode" id="modeBadge">현재 모드: -</span>
                                </div>
                            </div>

                            <!-- 필터 영역 -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="mb-1">지점 선택</label>
                                    <select class="form-control" id="branchId">
                                        <option value="" selected>지점을 선택하세요</option>
                                        <option th:each="b : ${branches}"
                                                th:value="${b.branchId}"
                                                th:text="${b.branchName}">
                                        </option>
                                    </select>
                                </div>

                                <div class="col-md-3">
                                    <label class="mb-1">단기/장기(가격 단위)</label>
                                    <select class="form-control" id="priceType">
                                        <option value="DAILY">단기(DAILY)</option>
                                        <option value="MONTHLY">장기(MONTHLY)</option>
                                    </select>
                                </div>

                                <div class="col-md-5 d-flex align-items-end">
                                    <button type="button" class="btn btn-primary mr-2" id="btnSearch">
                                        <i class="fa ti-search"></i> 조회
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="btnReset">
                                        <i class="fa ti-reload"></i> 초기화
                                    </button>
                                </div>
                            </div>

                            <!-- 배타 모드 안내 -->
                            <div class="alert alert-info" role="alert">
                                <b>운영 규칙</b><br/>
                                1) <b>지점 전체 적용(specId = null)</b>을 활성화하면, 동일 지점/단위의 <b>차종별</b> 정책은 자동 비활성화됩니다.<br/>
                                2) <b>차종별 적용(specId ≠ null)</b>을 활성화하면, 동일 지점/단위의 <b>지점 전체</b> 정책은 자동 비활성화됩니다.
                            </div>

                            <!-- 테이블 -->
                            <div class="table-responsive">
                                <table class="table table-hover table-bordered">
                                    <thead class="thead-light">
                                    <tr>
                                        <th style="width: 80px;">ID</th>
                                        <th style="width: 140px;">지점</th>
                                        <th style="width: 160px;">적용대상</th>
                                        <th style="width: 120px;">단위</th>
                                        <th style="width: 160px;">할인율(%)</th>
                                        <th style="width: 120px;">활성</th>
                                        <th style="width: 120px;">사용여부</th>
                                        <th style="width: 160px;">수정일</th>
                                        <th style="width: 180px;">작업</th>
                                    </tr>
                                    </thead>
                                    <tbody id="policyTbody">
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">지점을 선택하고 조회해 주세요.</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                            <p class="hint-text mt-2 mb-0">
                                * 할인율 수정은 <b>인라인 편집</b> 방식이며, 저장 시 서버에서 자동 보강(upsert) 로직이 동작할 수 있습니다.
                            </p>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- footer (기존 템플릿 있으면 교체) -->
        <footer>
            <div class="footer-area">
                <p>© CarPick Admin</p>
            </div>
        </footer>
    </div>
</div>

<!-- JS (기존 관리자 템플릿 그대로) -->
<script th:src="@{/assets/js/vendor/jquery-2.2.4.min.js}"></script>
<script th:src="@{/assets/js/popper.min.js}"></script>
<script th:src="@{/assets/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/owl.carousel.min.js}"></script>
<script th:src="@{/assets/js/metisMenu.min.js}"></script>
<script th:src="@{/assets/js/jquery.slimscroll.min.js}"></script>
<script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>
<script th:src="@{/assets/js/plugins.js}"></script>
<script th:src="@{/assets/js/scripts.js}"></script>

<script>
    const API_BASE = '/api/admin/price-policies';

    function getApplyTargetText(row) {
        if (row.specId == null) return '지점 전체 적용';
        return `차종별 적용 (${row.specName ?? ('specId=' + row.specId)})`;
    }

    function updateModeBadge(rows) {
        const active = rows.find(r => r.isActive === true);
        const badge = document.getElementById('modeBadge');
        if (!active) {
            badge.innerText = '현재 모드: 비활성';
            return;
        }
        badge.innerText = (active.specId == null)
            ? '현재 모드: 지점 전체 적용'
            : '현재 모드: 차종별 적용';
    }

    function renderTable(rows) {
        const tbody = document.getElementById('policyTbody');
        tbody.innerHTML = '';

        if (!rows || rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted">조회 결과가 없습니다.</td></tr>`;
            updateModeBadge([]);
            return;
        }

        updateModeBadge(rows);

        rows.forEach(row => {
            const tr = document.createElement('tr');
            if (row.isActive === false) tr.classList.add('row-disabled');

            tr.innerHTML = `
                <td>${row.pricePolicyId ?? '-'}</td>
                <td>${row.branchName ?? row.branchId}</td>
                <td>${getApplyTargetText(row)}</td>
                <td>${row.priceType}</td>

                <td>
                    <input type="number" min="0" max="100"
                           class="form-control inline-input"
                           value="${row.discountRate ?? 0}"
                           data-branch="${row.branchId}"
                           data-type="${row.priceType}"
                           data-spec="${row.specId ?? ''}">
                </td>

                <td class="text-center">
                    <input type="checkbox"
                           ${row.isActive ? 'checked' : ''}
                           data-branch="${row.branchId}"
                           data-type="${row.priceType}"
                           data-spec="${row.specId ?? ''}"
                           class="toggle-active">
                </td>

                <td class="text-center">
                    <select class="form-control" style="width: 90px; margin: 0 auto;"
                            data-id="${row.pricePolicyId}">
                        <option value="Y" ${row.useYn === 'Y' ? 'selected' : ''}>Y</option>
                        <option value="N" ${row.useYn === 'N' ? 'selected' : ''}>N</option>
                    </select>
                </td>

                <td>${row.updatedAt ?? '-'}</td>

                <td>
                    <button type="button" class="btn btn-sm btn-success btn-save"
                            data-id="${row.pricePolicyId}"
                            data-branch="${row.branchId}"
                            data-type="${row.priceType}"
                            data-spec="${row.specId ?? ''}">
                        저장
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete"
                            data-id="${row.pricePolicyId}">
                        삭제
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function fetchPolicies() {
        const branchId = document.getElementById('branchId').value;
        const priceType = document.getElementById('priceType').value;

        if (!branchId) {
            alert('지점을 선택해 주세요.');
            return;
        }

        const url = `${API_BASE}?branchId=${branchId}&priceType=${priceType}`;
        const res = await fetch(url);
        if (!res.ok) {
            alert('조회에 실패했습니다.');
            return;
        }
        const rows = await res.json();
        renderTable(rows);
    }

    async function saveDiscount(btn) {
        const branchId = btn.dataset.branch;
        const priceType = btn.dataset.type;
        const specId = btn.dataset.spec || '';

        const input = btn.closest('tr').querySelector('input[type="number"]');
        const discountRate = input.value;

        const params = new URLSearchParams({
            branchId: branchId,
            priceType: priceType,
            discountRate: discountRate
        });
        if (specId !== '') params.append('specId', specId);

        const res = await fetch(`${API_BASE}/discount-rate?` + params.toString(), { method: 'PATCH' });
        if (!res.ok) {
            alert('저장에 실패했습니다.');
            return;
        }
        await fetchPolicies();
    }

    async function toggleActive(el) {
        const branchId = el.dataset.branch;
        const priceType = el.dataset.type;
        const specId = el.dataset.spec || '';
        const isActive = el.checked;

        const params = new URLSearchParams({
            branchId: branchId,
            priceType: priceType,
            isActive: isActive
        });
        if (specId !== '') params.append('specId', specId);

        const res = await fetch(`${API_BASE}/active?` + params.toString(), { method: 'PATCH' });
        if (!res.ok) {
            alert('활성화 변경에 실패했습니다.');
            return;
        }
        await fetchPolicies();
    }

    async function changeUseYn(selectEl) {
        const pricePolicyId = selectEl.dataset.id;
        const useYn = selectEl.value;

        const params = new URLSearchParams({ useYn: useYn });
        const res = await fetch(`${API_BASE}/${pricePolicyId}/use-yn?` + params.toString(), { method: 'PATCH' });

        if (!res.ok) {
            alert('useYn 변경에 실패했습니다.');
            return;
        }
        await fetchPolicies();
    }

    async function softDelete(btn) {
        const id = btn.dataset.id;
        if (!id) {
            alert('삭제할 ID가 없습니다.');
            return;
        }
        if (!confirm('정말 삭제하시겠습니까?')) return;

        const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
        if (!res.ok) {
            alert('삭제에 실패했습니다.');
            return;
        }
        await fetchPolicies();
    }

    async function loadBranches() {
        const select = document.getElementById('branchId');
        select.innerHTML = '<option value="" selected>지점을 선택하세요</option>';

        const res = await fetch('/api/admin/branch', { method: 'GET' });
        if (!res.ok) {
            console.error('지점 목록 조회 실패', res.status);
            return;
        }

        const branches = await res.json();
        branches.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.branchId;
            opt.textContent = b.branchName;
            select.appendChild(opt);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadBranches();

        document.getElementById('btnSearch').addEventListener('click', fetchPolicies);
        document.getElementById('btnReset').addEventListener('click', () => {
            document.getElementById('branchId').value = '';
            document.getElementById('priceType').value = 'DAILY';
            document.getElementById('policyTbody').innerHTML =
                `<tr><td colspan="9" class="text-center text-muted">지점을 선택하고 조회해 주세요.</td></tr>`;
            document.getElementById('modeBadge').innerText = '현재 모드: -';
        });

        document.getElementById('policyTbody').addEventListener('click', async (e) => {
            const saveBtn = e.target.closest('.btn-save');
            const delBtn = e.target.closest('.btn-delete');
            if (saveBtn) await saveDiscount(saveBtn);
            if (delBtn) await softDelete(delBtn);
        });

        document.getElementById('policyTbody').addEventListener('change', async (e) => {
            if (e.target.classList.contains('toggle-active')) {
                await toggleActive(e.target);
            }
            if (e.target.matches('select')) {
                await changeUseYn(e.target);
            }
        });
    });
</script>

</body>
</html>
