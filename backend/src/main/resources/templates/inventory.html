<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <title>카픽 - 차량 재고 관리</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- CSS -->
    <link rel="shortcut icon" type="image/png" href="assets/images/icon/favicon.ico">
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/common.css}">
    <link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
    <link rel="stylesheet" th:href="@{/assets/css/metisMenu.css}">
    <link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/slicknav.min.css}">

    <!-- amchart css (CDN) -->
    <link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />

    <!-- Others CSS -->
    <link rel="stylesheet" th:href="@{/assets/css/typography.css}">
    <link rel="stylesheet" th:href="@{/assets/css/default-css.css}">
    <link rel="stylesheet" th:href="@{/assets/css/styles.css}">
    <link rel="stylesheet" th:href="@{/assets/css/responsive.css}">

    <!-- JS -->
    <script th:src="@{/assets/js/vendor/modernizr-2.8.3.min.js}"></script>


    <style>
        .inventory-input {
            width: 100%;
            font-size: 0.85rem;
        }
        .inventory-input-sm {
            width: 100px;
        }
        .inventory-actions button {
            margin-right: 4px;
        }
        .table td, .table th {
            vertical-align: middle !important;
        }
        .car-thumbnail {
            width: 60px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        .badge-status {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 12px;
        }
        .badge-AVAILABLE { background-color: #28a745; color: white; }
        .badge-RESERVED { background-color: #ffc107; color: black; }
        .badge-RENTED { background-color: #17a2b8; color: white; }
        .badge-MAINTENANCE { background-color: #dc3545; color: white; }
    </style>
</head>

<body>

<div class="page-container">

    <!-- 사이드바 -->
    <div th:replace="fragments/fragments :: sidebar"></div>

    <!-- 헤더 -->
    <div th:replace="fragments/fragments :: header"></div>

    <!-- 본문 -->
    <div class="main-content">
        <div class="page-title-area">
            <div class="row align-items-center">
                <div class="col-sm-6">
                    <div class="breadcrumbs-area clearfix">
                        <h4 class="page-title pull-left">차량 재고 관리</h4>
                        <ul class="breadcrumbs pull-left">
                            <li><a href="/admin">홈</a></li>
                            <li><span>차량 재고 관리</span></li>
                        </ul>
                    </div>
                </div>
                <div class="col-sm-6 clearfix">
                    <button type="button"
                            class="user-profile user_writeBtn pull-right"
                            onclick="addEmptyRow()">
                        차량 등록
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content-inner">
            <div class="row">
                <div class="col-lg-12 mt-3">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="header-title">차량 재고 목록</h4>
                            <p class="text-muted" style="font-size: 0.85rem;">
                                · 실제 운영 차량(실차)을 관리합니다.<br>
                                · 차량번호, 차종, 지점, 연식 등을 입력 후 <strong>저장</strong> 버튼을 눌러 주세요.
                            </p>
                            <div class="single-table">
                                <div class="table-responsive">
                                    <table class="table text-center">
                                        <thead class="text-uppercase">
                                        <tr>
                                            <th style="width: 50px;">NO</th>

                                            <th style="width: 150px;">차종 선택</th>
                                            <th style="width: 120px;">차량번호</th>
                                            <th style="width: 80px;">연식</th>
                                            <th style="width: 100px;">주행거리</th>
                                            <th style="width: 130px;">지점</th>
                                            <th style="width: 110px;">상태</th>
                                            <th style="width: 130px;">최종수정일</th>
                                            <th style="width: 120px;">관리</th>
                                        </tr>
                                        </thead>
                                        <tbody id="inventory-table-body">
                                        <!-- JS로 동적 렌더링 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="mt-2">
                                <span class="badge badge-info">TIP</span>
                                <span style="font-size: 0.8rem;">
                                    차량 등록 시 상태는 자동으로 '대여 가능'으로 설정됩니다.
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 푸터 -->
    <div th:replace="fragments/fragments :: footer"></div>

</div>

<!-- JS -->
<script th:src="@{/assets/js/vendor/jquery-2.2.4.min.js}"></script>
<script th:src="@{/assets/js/popper.min.js}"></script>
<script th:src="@{/assets/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/owl.carousel.min.js}"></script>
<script th:src="@{/assets/js/metisMenu.min.js}"></script>
<script th:src="@{/assets/js/jquery.slimscroll.min.js}"></script>
<script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>
<script th:src="@{/assets/js/plugins.js}"></script>
<script th:src="@{/assets/js/scripts.js}"></script>

<script>
    // 전역 데이터 (차종, 지점 목록)
    let specList = [];
    let branchList = [];

    // ================================
    //  초기 로딩
    // ================================
    $(document).ready(function () {
        // 차종, 지점 먼저 로드 → 재고 목록 로드
        Promise.all([
            loadSpecs(),
            loadBranches()
        ]).then(() => {
            loadInventory();
        });
    });

    function loadSpecs() {
        return $.ajax({
            url: '/api/admin/car-spec',
            method: 'GET',
            success: function (data) {
                specList = data || [];
            }
        });
    }

    function loadBranches() {
        return $.ajax({
            url: '/api/admin/branch',
            method: 'GET',
            success: function (data) {
                branchList = data || [];
            }
        });
    }

    function loadInventory() {
        $.ajax({
            url: '/api/admin/inventory',
            method: 'GET',
            success: function (data) {
                renderTable(data);
            },
            error: function (xhr) {
                console.error(xhr);
                alert('차량 재고 목록을 불러오는 중 오류가 발생했습니다.');
            }
        });
    }

    // ================================
    //  테이블 렌더링
    // ================================
    function renderTable(list) {
        const $tbody = $('#inventory-table-body');
        $tbody.empty();

        if (!list || list.length === 0) {
            $tbody.append('<tr><td colspan="10">등록된 차량이 없습니다. 상단의 [차량 등록] 버튼으로 새 차량을 추가해 주세요.</td></tr>');
            return;
        }

        list.forEach(function (item, index) {
            const rowHtml = createRowHtml(item, index + 1);
            $tbody.append(rowHtml);
        });
    }

    function createRowHtml(item, no) {
        const id = item.vehicleId || '';
        const specId = item.specId || '';
        const branchId = item.branchId || '';
        const vehicleNo = item.vehicleNo || '';
        const modelYear = item.modelYear || '';
        const mileage = item.mileage || 0;
        const status = item.operationalStatus || 'AVAILABLE';
        const updatedAt = item.updatedAt || '';

        const modelName = item.modelName || '';
        const brand = item.brand || '';

        // 차종 select 옵션 생성
        let specOptions = '<option value="">차종 선택</option>';
        specList.forEach(function (spec) {
            const selected = (spec.specId == specId) ? 'selected' : '';
            specOptions += `<option value="${spec.specId}" ${selected}>${spec.brand} ${spec.modelName}</option>`;
        });

        // 지점 select 옵션 생성
        let branchOptions = '<option value="">지점 선택</option>';
        branchList.forEach(function (branch) {
            const selected = (branch.branchId == branchId) ? 'selected' : '';
            branchOptions += `<option value="${branch.branchId}" ${selected}>${branch.branchName}</option>`;
        });

        // 상태 select 옵션 생성
        const statusOptions = `
            <option value="AVAILABLE" ${status === 'AVAILABLE' ? 'selected' : ''}>대여 가능</option>
            <option value="RESERVED" ${status === 'RESERVED' ? 'selected' : ''}>예약 중</option>
            <option value="RENTED" ${status === 'RENTED' ? 'selected' : ''}>대여 중</option>
            <option value="MAINTENANCE" ${status === 'MAINTENANCE' ? 'selected' : ''}>정비/점검</option>
        `;

        return `
            <tr data-id="${id}">
                <th scope="row">${no}</th>

                <td>
                    <select class="form-control form-control-sm inventory-input" data-field="specId" onchange="updateImage(this)">
                        ${specOptions}
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm inventory-input"
                           data-field="vehicleNo"
                           value="${escapeHtml(vehicleNo)}" placeholder="12가3456">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm inventory-input-sm"
                           data-field="modelYear"
                           value="${modelYear}" placeholder="2024" min="2015" max="2030">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm inventory-input-sm"
                           data-field="mileage"
                           value="${mileage}" placeholder="0" min="0">
                </td>
                <td>
                    <select class="form-control form-control-sm inventory-input" data-field="branchId">
                        ${branchOptions}
                    </select>
                </td>
                <td>
                    <select class="form-control form-control-sm inventory-input" data-field="operationalStatus">
                        ${statusOptions}
                    </select>
                </td>
                <td style="font-size:0.8rem;">${updatedAt}</td>
                <td class="inventory-actions">
                    <button type="button" class="btn btn-sm btn-primary" onclick="saveRow(this)">저장</button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteRow(this)">삭제</button>
                </td>
            </tr>
        `;
    }



    // ================================
    //  차량 등록 (빈 행)
    // ================================
    function addEmptyRow() {
        const $tbody = $('#inventory-table-body');

        const empty = {
            vehicleId: null,
            specId: '',
            branchId: '',
            vehicleNo: '',
            modelYear: new Date().getFullYear(),
            mileage: 0,
            operationalStatus: 'AVAILABLE',
            updatedAt: '',
            mainImageUrl: ''
        };

        const rowHtml = createRowHtml(empty, 1);

        // ✅ 맨 위에 추가
        $tbody.prepend(rowHtml);

        // ✅ NO 다시 매기기 (아래 함수 추가)
        renumberRows();

        // ✅ 바로 보이게 스크롤
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }


    // ================================
    //  저장 (신규/수정 공통)
    // ================================
    function saveRow(btn) {
        const $tr = $(btn).closest('tr');
        const id = $tr.data('id');

        const payload = {
            specId: $tr.find('[data-field="specId"]').val() || null,
            branchId: $tr.find('[data-field="branchId"]').val() || null,
            vehicleNo: $tr.find('[data-field="vehicleNo"]').val(),
            modelYear: parseInt($tr.find('[data-field="modelYear"]').val()) || null,
            mileage: parseInt($tr.find('[data-field="mileage"]').val()) || 0,
            operationalStatus: $tr.find('[data-field="operationalStatus"]').val()
        };

        // 숫자 변환
        if (payload.specId) payload.specId = parseInt(payload.specId);
        if (payload.branchId) payload.branchId = parseInt(payload.branchId);

        const method = id ? 'PUT' : 'POST';
        const url = id ? '/api/admin/inventory/' + id : '/api/admin/inventory';

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(payload),
            success: function (res) {
                const msg = res && res.message ? res.message : '저장되었습니다.';
                alert(msg);
                loadInventory();
            },
            error: function (xhr) {
                console.error(xhr);
                let msg = '저장 중 오류가 발생했습니다.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    msg = xhr.responseJSON.message;
                }
                alert(msg);
            }
        });
    }

    // ================================
    //  삭제
    // ================================
    function deleteRow(btn) {
        const $tr = $(btn).closest('tr');
        const id = $tr.data('id');

        if (!id) {
            $tr.remove();
            return;
        }

        if (!confirm('해당 차량을 삭제하시겠습니까?')) {
            return;
        }

        $.ajax({
            url: '/api/admin/inventory/' + id,
            method: 'DELETE',
            success: function (res) {
                const msg = res && res.message ? res.message : '삭제되었습니다.';
                alert(msg);
                loadInventory();
            },
            error: function (xhr) {
                console.error(xhr);
                let msg = '삭제 중 오류가 발생했습니다.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    msg = xhr.responseJSON.message;
                }
                alert(msg);
            }
        });
    }

    // ================================
    //  HTML 이스케이프
    // ================================
    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }
</script>

</body>
</html>