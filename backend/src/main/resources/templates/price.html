<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>카픽 - 가격 관리</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS -->
    <link rel="shortcut icon" type="image/png" href="assets/images/icon/favicon.ico">
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/common.css}">
    <link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
    <link rel="stylesheet" th:href="@{/assets/css/metisMenu.css}">
    <link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/slicknav.min.css}">
    <link rel="stylesheet" th:href="@{/assets/css/typography.css}">
    <link rel="stylesheet" th:href="@{/assets/css/default-css.css}">
    <link rel="stylesheet" th:href="@{/assets/css/styles.css}">
    <link rel="stylesheet" th:href="@{/assets/css/responsive.css}">

    <style>
        /* 관리자 레이아웃을 쓰므로 body 패딩은 제거 */
        body { background-color: #f8f9fa; }

        .table-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            overflow-x: auto;
        }

        th {
            vertical-align: middle;
            text-align: center;
            background-color: #f1f3f5;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        td { vertical-align: middle; padding: 8px !important; }

        .form-control-sm {
            border: 1px solid #dee2e6;
            text-align: right;
            font-size: 0.9rem;
        }
        .form-control-sm:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13,110,253,0.1);
        }

        .model-name { font-weight: 700; color: #212529; }
        .brand-name { font-size: 0.8rem; color: #868e96; }

        .badge-active { background-color: #28a745; }
        .badge-inactive { background-color: #dc3545; }

        .row-inactive {
            background-color: #f8d7da !important;
            opacity: 0.75;
        }
        .row-inactive input {
            background-color: #f5c6cb;
        }

        .btn-group-action {
            display: flex;
            gap: 6px;
            justify-content: center;
        }
    </style>
</head>

<body>
<div class="page-container">

    <!-- ✅ 사이드바/헤더: Spec 페이지와 동일하게 -->
    <div th:replace="fragments/fragments :: sidebar"></div>
    <div th:replace="fragments/fragments :: header"></div>

    <div class="main-content">
        <!-- ✅ 페이지 타이틀 영역 -->
        <div class="page-title-area">
            <div class="row align-items-center">
                <div class="col-sm-6">
                    <div class="breadcrumbs-area clearfix">
                        <h4 class="page-title pull-left">가격 관리</h4>
                        <ul class="breadcrumbs pull-left">
                            <li><a href="/admin">홈</a></li>
                            <li><span>가격 관리</span></li>
                        </ul>
                    </div>
                </div>

                <div class="col-sm-6 clearfix">
                    <button class="user-profile user_writeBtn pull-right" onclick="location.reload()">
                        <i class="ti-reload"></i> 새로고침
                    </button>
                </div>
            </div>
        </div>

        <!-- ✅ 본문 -->
        <div class="main-content-inner">
            <div class="row">
                <div class="col-lg-12 mt-4">
                    <div class="card">
                        <div class="card-body">

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="header-title mb-0">가격 목록</h4>
                                <span class="text-muted small">
                                    총 <b id="totalCount">0</b>개 항목
                                </span>
                            </div>

                            <div class="table-container">
                                <table class="table table-hover table-bordered align-middle">
                                    <thead class="table-light">
                                    <tr>
                                        <th style="width: 60px;">상태</th>
                                        <th style="width: 180px;">차량 정보</th>
                                        <th style="width: 160px;">일단가 (원)</th>
                                        <th style="width: 160px;">월단가 (원)</th>
                                        <th style="width: 160px;">최종 수정일</th>
                                        <th style="width: 180px;">관리</th>
                                    </tr>
                                    </thead>

                                    <tbody id="price-tbody">
                                    <tr>
                                        <td colspan="6" class="text-center py-4 text-muted">
                                            데이터를 불러오는 중입니다...
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div th:replace="fragments/fragments :: footer"></div>
</div>

<!-- ✅ 관리자 공통 JS (Spec 페이지와 동일하게) -->
<script th:src="@{/assets/js/vendor/jquery-2.2.4.min.js}"></script>
<script th:src="@{/assets/js/popper.min.js}"></script>
<script th:src="@{/assets/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/metisMenu.min.js}"></script>
<script th:src="@{/assets/js/jquery.slimscroll.min.js}"></script>
<script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>
<script th:src="@{/assets/js/scripts.js}"></script>

<script>
    // ======================================================
    //  페이지 로드
    // ======================================================
    document.addEventListener('DOMContentLoaded', loadPriceList);

    // ======================================================
    //  유틸 함수
    // ======================================================
    function formatNumber(value) {
        if (value === null || value === undefined || value === '') return '';
        const num = Number(value);
        if (Number.isNaN(num)) return String(value);
        return num.toLocaleString('ko-KR');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('ko-KR') + ' ' +
            date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
    }

    // ======================================================
    //  목록 조회
    // ======================================================
    function loadPriceList() {
        fetch('/api/admin/price')
            .then(res => {
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res.json();
            })
            .then(list => {
                document.getElementById('totalCount').innerText = list?.length ?? 0;
                renderTable(list);
            })
            .catch(err => {
                console.error('가격 목록 조회 오류:', err);
                document.getElementById('price-tbody').innerHTML =
                    '<tr><td colspan="6" class="text-center py-4 text-danger">가격 정보를 불러오는 중 오류가 발생했습니다.</td></tr>';
            });
    }

    // ======================================================
    //  테이블 렌더링
    // ======================================================
    function renderTable(list) {
        const tbody = document.getElementById('price-tbody');
        tbody.innerHTML = '';

        if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">등록된 가격 정보가 없습니다.</td></tr>';
            return;
        }

        list.forEach(dto => {
            const isActive = dto.useYn === 'Y';
            const tr = document.createElement('tr');
            tr.id = 'row-' + (dto.priceId ?? 'noid');

            if (!isActive) tr.classList.add('row-inactive');

            const priceId = dto.priceId ?? '';
            const specId = dto.specId ?? '';
            const dailyPrice = dto.dailyPrice ?? '';
            const monthlyPrice = dto.monthlyPrice ?? '';
            const version = dto.version ?? 0;
            const useYn = dto.useYn ?? 'Y';

            tr.innerHTML = `
                <input type="hidden" class="price-id" value="${priceId}">
                <input type="hidden" class="spec-id" value="${specId}">
                <input type="hidden" class="version" value="${version}">
                <input type="hidden" class="use-yn" value="${useYn}">

                <td class="text-center">
                    <span class="badge ${isActive ? 'badge-active' : 'badge-inactive'}">
                        ${isActive ? '활성' : '비활성'}
                    </span>
                </td>

                <td>
                    <div class="brand-name">${dto.brand ?? ''}</div>
                    <div class="model-name">${dto.modelName ?? ''}</div>
                </td>

                <td>
                    <input type="text"
                           class="form-control form-control-sm daily-price"
                           value="${formatNumber(dailyPrice)}"
                           placeholder="0"
                           oninput="formatInput(this)"
                           ${!isActive ? 'disabled' : ''}>
                </td>

                <td>
                    <input type="text"
                           class="form-control form-control-sm monthly-price"
                           value="${formatNumber(monthlyPrice)}"
                           placeholder="0"
                           oninput="formatInput(this)"
                           ${!isActive ? 'disabled' : ''}>
                </td>

                <td class="text-center" style="font-size: 0.85rem;">
                    ${formatDate(dto.updatedAt)}
                </td>

                <td>
                    <div class="btn-group-action">
                        ${isActive ? `
                            <button type="button" class="btn btn-primary btn-sm" onclick="saveRow(this)">저장</button>
                            <button type="button" class="btn btn-warning btn-sm" onclick="deactivateRow(this)">비활성화</button>
                        ` : `
                            <button type="button" class="btn btn-success btn-sm" onclick="activateRow(this)">활성화</button>
                        `}
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ======================================================
    //  입력 포맷팅
    // ======================================================
    function formatInput(input) {
        let value = input.value.replace(/[^\d]/g, '');
        if (value === '') { input.value = ''; return; }
        input.value = Number(value).toLocaleString('ko-KR');
    }

    function parseNumber(str) {
        if (!str || str === '') return null;
        const num = Number(str.replace(/[^\d]/g, ''));
        return isNaN(num) ? null : num;
    }

    // ======================================================
    //  저장
    // ======================================================
    function saveRow(btn) {
        const row = btn.closest('tr');

        const priceId = row.querySelector('.price-id').value;
        const specId = row.querySelector('.spec-id').value;
        const version = row.querySelector('.version').value;
        const dailyPrice = parseNumber(row.querySelector('.daily-price').value);
        const monthlyPrice = parseNumber(row.querySelector('.monthly-price').value);

        if (dailyPrice !== null && dailyPrice < 0) { alert('일단가는 0 이상이어야 합니다.'); return; }
        if (monthlyPrice !== null && monthlyPrice < 0) { alert('월단가는 0 이상이어야 합니다.'); return; }

        const data = {
            priceId: priceId === '' ? null : Number(priceId),
            specId: Number(specId),
            dailyPrice: dailyPrice,
            monthlyPrice: monthlyPrice,
            version: version === '' ? 0 : Number(version)
        };

        fetch('/api/admin/price', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    alert(res.message);
                    loadPriceList();
                } else {
                    alert('저장 실패: ' + res.message);
                }
            })
            .catch(err => {
                console.error('저장 오류:', err);
                alert('시스템 오류가 발생했습니다.');
            });
    }

    // ======================================================
    //  비활성화
    // ======================================================
    function deactivateRow(btn) {
        if (!confirm('이 가격을 비활성화하시겠습니까?\n비활성화하면 고객에게 노출되지 않습니다.')) return;

        const row = btn.closest('tr');
        const priceId = row.querySelector('.price-id').value;
        const version = row.querySelector('.version').value;

        fetch(`/api/admin/price/${priceId}/deactivate?version=${version}`, { method: 'PATCH' })
            .then(res => res.json())
            .then(res => {
                if (res.success) { alert(res.message); loadPriceList(); }
                else { alert('비활성화 실패: ' + res.message); }
            })
            .catch(err => {
                console.error('비활성화 오류:', err);
                alert('시스템 오류가 발생했습니다.');
            });
    }

    // ======================================================
    //  활성화
    // ======================================================
    function activateRow(btn) {
        if (!confirm('이 가격을 다시 활성화하시겠습니까?')) return;

        const row = btn.closest('tr');
        const priceId = row.querySelector('.price-id').value;
        const version = row.querySelector('.version').value;

        fetch(`/api/admin/price/${priceId}/activate?version=${version}`, { method: 'PATCH' })
            .then(res => res.json())
            .then(res => {
                if (res.success) { alert(res.message); loadPriceList(); }
                else { alert('활성화 실패: ' + res.message); }
            })
            .catch(err => {
                console.error('활성화 오류:', err);
                alert('시스템 오류가 발생했습니다.');
            });
    }
</script>
</body>
</html>
