<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
	<meta charset="UTF-8">
	<title>카픽 - 예약 관리</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- CSS (지점관리와 동일) -->
	<link rel="shortcut icon" type="image/png" href="assets/images/icon/favicon.ico">
	<link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
	<link rel="stylesheet" th:href="@{/assets/css/font-awesome.min.css}">
	<link rel="stylesheet" th:href="@{/assets/css/common.css}">
	<link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
	<link rel="stylesheet" th:href="@{/assets/css/metisMenu.css}">
	<link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}">
	<link rel="stylesheet" th:href="@{/assets/css/slicknav.min.css}">

	<!-- amchart css (CDN) -->
	<link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />

	<!-- Others CSS -->
	<link rel="stylesheet" th:href="@{/assets/css/typography.css}">
	<link rel="stylesheet" th:href="@{/assets/css/default-css.css}">
	<link rel="stylesheet" th:href="@{/assets/css/styles.css}">
	<link rel="stylesheet" th:href="@{/assets/css/responsive.css}">

	<!-- JS (헤더에서 필요) -->
	<script th:src="@{/assets/js/vendor/modernizr-2.8.3.min.js}"></script>

	<style>
		/* 예약 관리 페이지에서만 쓰는 소소한 보정 */
		.table td, .table th { vertical-align: middle !important; }
		.badge { font-size: 0.8rem; }
	</style>
</head>

<body>

<div class="page-container">

	<!-- 사이드바 -->
	<div th:replace="fragments/fragments :: sidebar"></div>

	<!-- 헤더 -->
	<div th:replace="fragments/fragments :: header"></div>

	<!-- 본문 -->
	<div class="main-content">
		<div class="page-title-area">
			<div class="row align-items-center">
				<div class="col-sm-6">
					<div class="breadcrumbs-area clearfix">
						<h4 class="page-title pull-left">예약 관리</h4>
						<ul class="breadcrumbs pull-left">
							<li><a href="/admin">홈</a></li>
							<li><span>예약 관리</span></li>
						</ul>
					</div>
				</div>
			</div>
		</div>

		<div class="main-content-inner">
			<div class="row">
				<div class="col-lg-12 mt-3">

					<!-- 검색 필터 -->
					<div class="card mb-4">
						<div class="card-body">
							<form id="searchForm" class="row g-3">
								<div class="col-md-2">
									<label class="form-label">예약 상태</label>
									<select id="status" class="form-control">
										<option value="">전체</option>
										<option value="PENDING">대기</option>
										<option value="CONFIRMED">확정</option>
										<option value="ACTIVE">이용중</option>
										<option value="COMPLETED">완료</option>
										<option value="CANCELED">취소</option>
									</select>
								</div>

								<div class="col-md-2">
									<label class="form-label">시작일</label>
									<input type="date" id="fromDate" class="form-control">
								</div>

								<div class="col-md-2">
									<label class="form-label">종료일</label>
									<input type="date" id="toDate" class="form-control">
								</div>

								<div class="col-md-4">
									<label class="form-label">검색</label>
									<input type="text" id="keyword" class="form-control"
										   placeholder="예약번호, 예약자명, 차량번호">
								</div>

								<div class="col-md-2 d-flex align-items-end">
									<button type="button" id="btnSearch" class="btn btn-primary w-100">
										<i class="fa fa-search"></i> 검색
									</button>
								</div>
							</form>
						</div>
					</div>

					<!-- 목록 테이블 -->
					<div class="card">
						<div class="card-body">
							<div class="single-table">
								<div class="table-responsive">
									<table class="table table-hover text-center">
										<thead class="text-uppercase">
										<tr>
											<th>No</th>
											<th>예약번호</th>
											<th>예약자</th>
											<th>차량</th>
											<th>차량번호</th>
											<th>대여기간</th>
											<th>결제금액</th>
											<th>상태</th>
											<th>관리</th>
										</tr>
										</thead>
										<tbody id="reservationTableBody"></tbody>
									</table>
								</div>
							</div>

							<!-- 데이터 없음 -->
							<div id="noData" class="text-center py-5" style="display:none;">
								<p class="text-muted">조회된 예약이 없습니다.</p>
							</div>

							<!-- 페이지네이션 -->
							<nav id="paginationNav" class="d-flex justify-content-center mt-4">
								<ul class="pagination" id="pagination"></ul>
							</nav>
						</div>
					</div>

				</div>
			</div>
		</div>
	</div>

	<!-- 푸터 -->
	<div th:replace="fragments/fragments :: footer"></div>

</div>

<!-- JS (지점관리와 동일) -->
<script th:src="@{/assets/js/vendor/jquery-2.2.4.min.js}"></script>
<script th:src="@{/assets/js/popper.min.js}"></script>
<script th:src="@{/assets/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/owl.carousel.min.js}"></script>
<script th:src="@{/assets/js/metisMenu.min.js}"></script>
<script th:src="@{/assets/js/jquery.slimscroll.min.js}"></script>
<script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>
<script th:src="@{/assets/js/plugins.js}"></script>
<script th:src="@{/assets/js/scripts.js}"></script>

<script>
	let currentPage = 1;
	const pageSize = 10;

	document.addEventListener('DOMContentLoaded', function() {
		loadReservationList();

		document.getElementById('btnSearch').addEventListener('click', function() {
			currentPage = 1;
			loadReservationList();
		});

		document.getElementById('keyword').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				e.preventDefault();
				currentPage = 1;
				loadReservationList();
			}
		});
	});

	function loadReservationList() {
		const status = document.getElementById('status').value;
		const fromDate = document.getElementById('fromDate').value;
		const toDate = document.getElementById('toDate').value;
		const keyword = document.getElementById('keyword').value;

		const params = new URLSearchParams();
		if (status) params.append('status', status);
		if (fromDate) params.append('fromDate', fromDate);
		if (toDate) params.append('toDate', toDate);
		if (keyword) params.append('keyword', keyword);
		params.append('page', currentPage);
		params.append('size', pageSize);

		fetch(`/api/admin/reservation/list?${params.toString()}`)
				.then(r => r.json())
				.then(result => {
					renderTable(result.data);
					renderPagination(result.pagination);
				})
				.catch(err => {
					console.error(err);
					alert('데이터 조회 중 오류가 발생했습니다.');
				});
	}

	function renderTable(list) {
		const tbody = document.getElementById('reservationTableBody');
		const noData = document.getElementById('noData');

		if (!list || list.length === 0) {
			tbody.innerHTML = '';
			noData.style.display = 'block';
			return;
		}
		noData.style.display = 'none';

		tbody.innerHTML = list.map((item, index) => `
            <tr>
                <td>${index + 1 + (currentPage - 1) * pageSize}</td>
                <td>${item.reservationNo || '-'}</td>
                <td>${item.name || '-'}</td>
                <td>${item.displayNameShort || '-'}</td>
                <td>${item.carNo || '-'}</td>
                <td>
                    ${formatDateTime(item.startDate)}<br>
                    ~ ${formatDateTime(item.endDate)}
                </td>
                <td>${formatCurrency(item.totalAmountSnapshot)}</td>
                <td>${renderStatusBadge(item.reservationStatus)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="goDetail(${item.reservationId})">
                        <i class="fa fa-file-text-o"></i>
                    </button>
                </td>
            </tr>
        `).join('');
	}

	function renderStatusBadge(status) {
		const statusMap = {
			'PENDING': { text: '대기', class: 'badge badge-warning' },
			'CONFIRMED': { text: '확정', class: 'badge badge-success' },
			'ACTIVE': { text: '이용중', class: 'badge badge-primary' },
			'COMPLETED': { text: '완료', class: 'badge badge-secondary' },
			'CANCELED': { text: '취소', class: 'badge badge-danger' },
			'CHANGED': { text: '변경', class: 'badge badge-info' }
		};

		const info = statusMap[status] || { text: status, class: 'badge badge-secondary' };
		return `<span class="${info.class}">${info.text}</span>`;
	}

	function renderPagination(pagination) {
		const nav = document.getElementById('pagination');

		if (!pagination || pagination.totalPage === 0) {
			nav.innerHTML = '';
			return;
		}

		let html = '';

		if (pagination.prev) {
			html += `<li class="page-item">
                <a class="page-link" href="#" onclick="goPage(${pagination.startPage - 1});return false;">이전</a>
            </li>`;
		}

		for (let i = pagination.startPage; i <= pagination.endPage; i++) {
			const active = (i === pagination.currentPage) ? 'active' : '';
			html += `<li class="page-item ${active}">
                <a class="page-link" href="#" onclick="goPage(${i});return false;">${i}</a>
            </li>`;
		}

		if (pagination.next) {
			html += `<li class="page-item">
                <a class="page-link" href="#" onclick="goPage(${pagination.endPage + 1});return false;">다음</a>
            </li>`;
		}

		nav.innerHTML = html;
	}

	function goPage(page) {
		currentPage = page;
		loadReservationList();
	}

	function goDetail(reservationId) {
		window.location.href = `/api/admin/reservation/detail/${reservationId}`;
	}

	function formatDateTime(dateStr) {
		if (!dateStr) return '-';
		return dateStr.replace('T', ' ').substring(0, 16);
	}

	function formatCurrency(amount) {
		const n = Number(amount ?? 0);
		return '₩' + n.toLocaleString();
	}
</script>

</body>
</html>
