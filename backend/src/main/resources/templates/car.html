<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
	<meta charset="UTF-8">
	<title>ì¹´í”½ - ì°¨ëŸ‰ ëª¨ë¸(Spec) ê´€ë¦¬</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- CSS -->
	<link rel="shortcut icon" type="image/png" href="assets/images/icon/favicon.ico">
	<link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
	<link rel="stylesheet" th:href="@{/assets/css/font-awesome.min.css}">
	<link rel="stylesheet" th:href="@{/assets/css/common.css}">
	<link rel="stylesheet" th:href="@{/assets/css/themify-icons.css}">
	<link rel="stylesheet" th:href="@{/assets/css/metisMenu.css}">
	<link rel="stylesheet" th:href="@{/assets/css/owl.carousel.min.css}">
	<link rel="stylesheet" th:href="@{/assets/css/slicknav.min.css}">

	<!-- amchart css (CDN) -->
	<link rel="stylesheet" href="https://www.amcharts.com/lib/3/plugins/export/export.css" type="text/css" media="all" />

	<!-- Others CSS -->
	<link rel="stylesheet" th:href="@{/assets/css/typography.css}">
	<link rel="stylesheet" th:href="@{/assets/css/default-css.css}">
	<link rel="stylesheet" th:href="@{/assets/css/styles.css}">
	<link rel="stylesheet" th:href="@{/assets/css/responsive.css}">

	<script th:src="@{/assets/js/vendor/modernizr-2.8.3.min.js}"></script>

	<style>
		/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ë³´ì • */
		.modal-body label { font-weight: 600; margin-top: 10px; }
	</style>
</head>

<body>

<div class="page-container">

	<div th:replace="fragments/fragments :: sidebar"></div>

	<div th:replace="fragments/fragments :: header"></div>

	<div class="main-content">
		<div class="page-title-area">
			<div class="row align-items-center">
				<div class="col-sm-6">
					<div class="breadcrumbs-area clearfix">
						<h4 class="page-title pull-left">ì°¨ëŸ‰ ëª¨ë¸(Spec) ê´€ë¦¬</h4>
						<ul class="breadcrumbs pull-left">
							<li><a href="/admin">í™ˆ</a></li>
							<li><span>ì°¨ëŸ‰ ëª¨ë¸ ê´€ë¦¬</span></li>
						</ul>
					</div>
				</div>
				<div class="col-sm-6 clearfix">
					<button class="user-profile user_writeBtn pull-right" onclick="openModal('new')">
						<i class="ti-plus"></i> ì‹ ê·œ ë“±ë¡
					</button>
				</div>
			</div>
		</div>

		<div class="main-content-inner">
			<div class="row">

				<div class="col-lg-12 mt-4">
					<div class="card">
						<div class="card-body">
							<div class="d-flex justify-content-between align-items-center mb-3">
								<h4 class="header-title mb-0">ë³´ìœ  ì°¨ì¢… ëª©ë¡</h4>
								<span class="text-muted small">ì´ <b id="totalCount">0</b>ê°œ ëª¨ë¸</span>
							</div>

							<div class="single-table">
								<div class="table-responsive">
									<table class="table text-center table-hover">
										<thead class="text-uppercase bg-light">
										<tr>
											<th scope="col" width="5%">ID</th>
											<th scope="col" width="10%">ë¸Œëœë“œ</th>
											<th scope="col" width="15%">ëª¨ë¸ëª…(í‘œì‹œ)</th>
											<th scope="col" width="10%">ì—°ì‹</th>
											<th scope="col" width="10%">ì—°ë£Œ</th>
											<th scope="col" width="10%">ë“±ê¸‰</th>
											<th scope="col">ì˜µì…˜ìš”ì•½</th>
											<th scope="col" width="15%">ê´€ë¦¬</th>
										</tr>
										</thead>
										<tbody id="carListBody">
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div th:replace="fragments/fragments :: footer"></div>

</div>

<div class="modal fade" id="specModal" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="modalTitle">ì°¨ëŸ‰ ëª¨ë¸ ì •ë³´</h5>
				<button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
			</div>
			<div class="modal-body">
				<form id="specForm">
					<input type="hidden" id="specId">

					<h6 class="text-primary border-bottom pb-2">ğŸ“Œ ê¸°ë³¸ ì œì› (í´ë”ëª… ì—°ë™)</h6>
					<div class="form-row">
						<div class="col-md-6 mb-3">
							<label>ë¸Œëœë“œ</label>
							<select class="form-control" id="brand">
								<option value="HYUNDAI">í˜„ëŒ€ (HYUNDAI)</option>
								<option value="KIA">ê¸°ì•„ (KIA)</option>
								<option value="GENESIS">ì œë„¤ì‹œìŠ¤ (GENESIS)</option>
								<option value="BMW">BMW</option>
								<option value="BENZ">ë²¤ì¸  (BENZ)</option>
							</select>
						</div>
						<div class="col-md-6 mb-3">
							<label>ëª¨ë¸ ì½”ë“œ (í´ë”ëª…)</label>
							<input type="text" class="form-control" id="modelName" placeholder="ì˜ˆ: avante_cn7">
							<small class="text-muted">â€» ì´ë¯¸ì§€ í´ë”ëª…ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.</small>
						</div>
						<div class="form-row mt-3">
							<div class="col-md-6 mb-3">
								<label class="text-danger">ğŸ“¸ ë©”ì¸ ì´ë¯¸ì§€ (JPG)</label>
								<input type="file" class="form-control-file" id="mainImageFile" accept=".jpg, .jpeg">
								<small class="text-muted">ì°¨ëŸ‰ ëª©ë¡ ë° ìƒì„¸ ìƒë‹¨ì— ë…¸ì¶œë©ë‹ˆë‹¤.</small>
							</div>
							<div class="col-md-6 mb-3">
								<label class="text-primary">ğŸ”„ 360ë„ ì´ë¯¸ì§€ (WEBP)</label>
								<input type="file" class="form-control-file" id="rotatableImageFile" accept=".webp">
								<small class="text-muted">360ë„ ë·°ì–´ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</small>
							</div>
						</div>
					</div>

					<h6 class="text-success border-bottom pb-2 mt-3">âœï¸ ìƒì„¸ ì •ë³´ (ììœ  ìˆ˜ì •)</h6>
					<div class="form-row">
						<div class="col-md-4 mb-3">
							<label>í‘œì‹œ ëª¨ë¸ëª… (í•œê¸€)</label>
							<input type="text" class="form-control" id="displayNameShort" placeholder="ì˜ˆ: ë” ë‰´ ì•„ë°˜ë–¼">
						</div>
						<div class="col-md-4 mb-3">
							<label>ì—°ì‹ (Year)</label>
							<input type="number" class="form-control" id="modelYearBase" placeholder="2025">
						</div>
						<div class="col-md-4 mb-3">
							<label>ì—°ë£Œ íƒ€ì…</label>
							<select class="form-control" id="fuelType">
								<option value="GASOLINE">ê°€ì†”ë¦°</option>
								<option value="DIESEL">ë””ì ¤</option>
								<option value="HYBRID">í•˜ì´ë¸Œë¦¬ë“œ</option>
								<option value="ELECTRIC">ì „ê¸°(EV)</option>
								<option value="LPG">LPG</option>
							</select>
						</div>
					</div>

					<div class="form-row">
						<div class="col-md-6 mb-3">
							<label>ì°¨ëŸ‰ ë“±ê¸‰</label>
							<select class="form-control" id="carClass">
								<option value="COMPACT">ì¤€ì¤‘í˜•</option>
								<option value="MID">ì¤‘í˜•</option>
								<option value="LARGE">ëŒ€í˜•</option>
								<option value="SUV">SUV</option>
								<option value="RV">RV</option>
							</select>
						</div>
						<div class="col-md-6 mb-3">
							<label>ìŠ¹ì°¨ ì •ì›</label>
							<input type="number" class="form-control" id="seatingCapacity" value="5">
						</div>
					</div>

					<div class="form-group">
						<label>AI ìš”ì•½ ë¬¸êµ¬</label>
						<textarea class="form-control" id="aiSummary" rows="2" placeholder="ì°¨ëŸ‰ ìƒì„¸í˜ì´ì§€ ìƒë‹¨ì— ë…¸ì¶œë  ë¬¸êµ¬ì…ë‹ˆë‹¤."></textarea>
					</div>

					<div class="form-group">
						<label>ë³´ìœ  ì˜µì…˜ (ì‰¼í‘œ êµ¬ë¶„)</label>
						<input type="text" class="form-control" id="carOptions" placeholder="ì˜ˆ: ë„¤ë¹„ê²Œì´ì…˜,ì¬ë£¨í”„,í†µí’ì‹œíŠ¸">
					</div>

					<div class="form-row">
						<div class="col-md-6 mb-3">
							<label>ìµœì†Œ ìš´ì „ ì—°ë ¹</label>
							<input type="number" class="form-control" id="minDriverAge" value="21">
						</div>
						<div class="col-md-6 mb-3">
							<label>ìµœì†Œ ë©´í—ˆ ê²½ë ¥(ë…„)</label>
							<input type="number" class="form-control" id="minLicenseYears" value="1">
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">ì·¨ì†Œ</button>
				<button type="button" class="btn btn-primary" onclick="saveData()">ì €ì¥í•˜ê¸°</button>
			</div>
		</div>
	</div>
</div>

<script th:src="@{/assets/js/vendor/jquery-2.2.4.min.js}"></script>
<script th:src="@{/assets/js/popper.min.js}"></script>
<script th:src="@{/assets/js/bootstrap.min.js}"></script>
<script th:src="@{/assets/js/metisMenu.min.js}"></script>
<script th:src="@{/assets/js/jquery.slimscroll.min.js}"></script>
<script th:src="@{/assets/js/jquery.slicknav.min.js}"></script>
<script th:src="@{/assets/js/scripts.js}"></script>

<script>
	$(document).ready(function() {
		loadCarList();
	});

	// 1. ëª©ë¡ ì¡°íšŒ
	function loadCarList() {
		$.ajax({
			url: '/admin/api/car/spec',
			type: 'GET',
			success: function(data) {
				let html = '';
				$('#totalCount').text(data.length); // ì´ ê°œìˆ˜ í‘œì‹œ

				if(data.length === 0) {
					html = '<tr><td colspan="8" class="py-4">ë“±ë¡ëœ ì°¨ëŸ‰ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤. ì‹ ê·œ ë“±ë¡ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.</td></tr>';
				} else {
					data.forEach(function(car) {
						html += `
                            <tr>
                                <th scope="row">${car.specId}</th>
                                <td><span class="badge badge-dark">${car.brand}</span></td>
                                <td class="font-weight-bold">${car.displayNameShort || car.modelName}</td>
                                <td>${car.modelYearBase}</td>
                                <td>${car.fuelType}</td>
                                <td>${car.carClass}</td>
                                <td class="text-left"><small>${car.carOptions || '-'}</small></td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick='openModal("edit", ${JSON.stringify(car)})' title="ìˆ˜ì •">
                                        <i class="ti-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick='cloneCar(${JSON.stringify(car)})' title="ë³µì œë“±ë¡">
                                        <i class="ti-files"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteItem(${car.specId})" title="ì‚­ì œ">
                                        <i class="ti-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
					});
				}
				$('#carListBody').html(html);
			},
			error: function(err) {
				console.error(err);
				alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
			}
		});
	}

	// 2. ëª¨ë‹¬ ì—´ê¸°
	function openModal(mode, car = null) {
		$('#specForm')[0].reset();

		if (mode === 'new') {
			$('#modalTitle').text('âœ¨ ì‹ ê·œ ëª¨ë¸ ë“±ë¡');
			$('#specId').val('');
			$('#brand').prop('disabled', false);
			$('#modelName').prop('readonly', false);
		} else if (mode === 'edit') {
			$('#modalTitle').text('ğŸ”§ ëª¨ë¸ ì •ë³´ ìˆ˜ì •');
			fillFormData(car);
			// ìˆ˜ì • ì‹œ ë¸Œëœë“œ/ëª¨ë¸ì½”ë“œëŠ” ìˆ˜ì • ë¶ˆê°€
			$('#brand').prop('disabled', true);
			$('#modelName').prop('readonly', true);
		}
		$('#specModal').modal('show');
	}

	// 3. ë³µì œ ë“±ë¡
	function cloneCar(car) {
		if (!confirm(`[${car.displayNameShort}] ì •ë³´ë¥¼ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

		openModal('new'); // ì‹ ê·œ ëª¨ë“œë¡œ ì—´ê¸°
		fillFormData(car); // ë°ì´í„° ì±„ìš°ê¸°
		$('#specId').val(''); // ID ì œê±° (ì‹ ê·œ ë“±ë¡)

		// ë³µì œ í›„ì—ëŠ” ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ í’ˆ
		$('#brand').prop('disabled', false);
		$('#modelName').prop('readonly', false);

		// ì•ˆë‚´
		setTimeout(() => alert('ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ì‹(Year) ë“±ì„ ìˆ˜ì •í•œ ë’¤ ì €ì¥í•˜ì„¸ìš”!'), 300);
	}

	function fillFormData(car) {
		$('#specId').val(car.specId);
		$('#brand').val(car.brand);
		$('#modelName').val(car.modelName);
		$('#displayNameShort').val(car.displayNameShort);
		$('#modelYearBase').val(car.modelYearBase);
		$('#fuelType').val(car.fuelType);
		$('#carClass').val(car.carClass);
		$('#aiSummary').val(car.aiSummary);
		$('#carOptions').val(car.carOptions);
		$('#seatingCapacity').val(car.seatingCapacity);
		$('#minDriverAge').val(car.minDriverAge);
		$('#minLicenseYears').val(car.minLicenseYears);
	}

	// 4. ì €ì¥ (íŒŒì¼ ì—…ë¡œë“œ ì§€ì› ë²„ì „)
	function saveData() {
		// 1. íŒŒì¼ê³¼ í…ìŠ¤íŠ¸ë¥¼ ë‹´ì„ FormData ê°ì²´ ìƒì„±
		const formData = new FormData();

		// 2. ì¼ë°˜ í…ìŠ¤íŠ¸ ë°ì´í„° ë‹´ê¸°
		formData.append('brand', $('#brand').val());
		formData.append('modelName', $('#modelName').val());
		formData.append('displayNameShort', $('#displayNameShort').val());
		formData.append('modelYearBase', parseInt($('#modelYearBase').val() || 0));
		formData.append('fuelType', $('#fuelType').val());
		formData.append('carClass', $('#carClass').val());
		formData.append('aiSummary', $('#aiSummary').val());
		formData.append('carOptions', $('#carOptions').val());
		formData.append('seatingCapacity', parseInt($('#seatingCapacity').val() || 5));
		formData.append('minDriverAge', parseInt($('#minDriverAge').val() || 21));
		formData.append('minLicenseYears', parseInt($('#minLicenseYears').val() || 1));

		// 3. íŒŒì¼ ë°ì´í„° ë‹´ê¸° (íŒŒì¼ì´ ì„ íƒë˜ì—ˆì„ ë•Œë§Œ)
		const mainFile = $('#mainImageFile')[0].files[0];
		const rotateFile = $('#rotatableImageFile')[0].files[0];

		if(mainFile) {
			formData.append('mainImage', mainFile); // ë°±ì—”ë“œ DTOì˜ í•„ë“œëª…ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
		}
		if(rotateFile) {
			formData.append('rotatableImage', rotateFile); // ë°±ì—”ë“œ DTOì˜ í•„ë“œëª…ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
		}

		// 4. í•„ìˆ˜ê°’ ì²´í¬
		if(!$('#brand').val() || !$('#modelName').val() || !$('#modelYearBase').val()) {
			alert('ë¸Œëœë“œ, ëª¨ë¸ì½”ë“œ, ì—°ì‹ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
			return;
		}

		// 5. URL ì„¤ì •
		const id = $('#specId').val();
		// ìˆ˜ì •(IDìˆìŒ)ì´ë©´ URL ë’¤ì— ID ë¶™ì„
		const url = id ? '/admin/api/car/spec/' + id : '/admin/api/car/spec';

		// ì¤‘ìš”: íŒŒì¼ ì—…ë¡œë“œëŠ” ë³´í†µ POSTë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
		// (ë°±ì—”ë“œì—ì„œ ìˆ˜ì • ìš”ì²­ë„ POSTë¡œ ë°›ë„ë¡ ì²˜ë¦¬í•˜ëŠ” ê²Œ ì •ì‹ ê±´ê°•ì— ì¢‹ìŠµë‹ˆë‹¤)
		const method = 'POST';

		$.ajax({
			url: url,
			type: method,
			data: formData,           // JSON.stringifyê°€ ì•„ë‹ˆë¼ formDataë¥¼ ê·¸ëŒ€ë¡œ ë„£ìŠµë‹ˆë‹¤.
			enctype: 'multipart/form-data',
			processData: false,       // í•„ìˆ˜: ë°ì´í„°ë¥¼ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ìœ¼ë¡œ ë³€í™˜ ê¸ˆì§€
			contentType: false,       // í•„ìˆ˜: í—¤ë” ìë™ ì„¤ì • ê¸ˆì§€ (multipart ìë™ ì¸ì‹)
			success: function(res) {
				if (res.success) {
					alert(res.message);
					$('#specModal').modal('hide');
					loadCarList();
				} else {
					alert('ì‹¤íŒ¨: ' + res.message);
				}
			},
			error: function(xhr) {
				const res = xhr.responseJSON;
				alert(res && res.message ? res.message : 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
			}
		});
	}

	// 5. ì‚­ì œ
	function deleteItem(id) {
		if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

		$.ajax({
			url: '/admin/api/car/spec/' + id,
			type: 'DELETE',
			success: function(res) {
				if (res.success) {
					alert(res.message);
					loadCarList();
				} else {
					alert('ì‚­ì œ ë¶ˆê°€: ' + res.message);
				}
			},
			error: function(xhr) {
				const res = xhr.responseJSON;
				alert(res && res.message ? res.message : 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
			}
		});
	}
</script>

</body>
</html>