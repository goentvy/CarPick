<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.carpick.domain.reservationHistory.mapper.ReservationStatusHistoryMapper">

    <resultMap id="HistoryResultMap"
               type="com.carpick.domain.reservationHistory.entity.ReservationStatusHistory">
        <id property="historyId" column="history_id"/>
        <result property="reservationId" column="reservation_id"/>

        <result property="statusPrev" column="status_prev"/>
        <result property="statusCurr" column="status_curr"/>

        <result property="actorType" column="actor_type"/>
        <result property="actorId" column="actor_id"/>
        <result property="reason" column="reason"/>

        <result property="recordedAt" column="recorded_at"/>
    </resultMap>

    <insert id="insertHistory"
            parameterType="com.carpick.domain.reservationHistory.entity.ReservationStatusHistory">
        INSERT INTO RESERVATION_STATUS_HISTORY (
            reservation_id,
            status_prev,
            status_curr,
            actor_type,
            actor_id,
            reason
        ) VALUES (
                     #{reservationId},
                     #{statusPrev},
                     #{statusCurr},
                     #{actorType},
                     #{actorId},
                     #{reason}
                 )
    </insert>

    <select id="selectHistoryByReservationId" resultMap="HistoryResultMap">
        SELECT
            history_id,
            reservation_id,
            status_prev,
            status_curr,
            actor_type,
            actor_id,
            reason,
            recorded_at
        FROM RESERVATION_STATUS_HISTORY
        WHERE reservation_id = #{reservationId}
        ORDER BY recorded_at DESC, history_id DESC
    </select>

</mapper>