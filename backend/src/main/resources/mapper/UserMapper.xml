<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.carpick.domain.auth.mapper.UserMapper">

    <!-- ===================== -->
    <!-- ResultMap -->
    <!-- ===================== -->

    <resultMap id="UserResultMap" type="com.carpick.domain.auth.entity.User">

        <id property="userId" column="user_id"/>

        <result property="email" column="email"/>
        <result property="password" column="password"/>
        <result property="provider" column="provider"/>
        <result property="providerId" column="provider_id"/>

        <result property="name" column="name"/>
        <result property="phone" column="phone"/>
        <result property="birth" column="birth"/>

        <result property="gender"
                column="gender"
                typeHandler="com.carpick.global.mybatis.handler.GenderTypeHandler"/>

        <result property="marketingAgree" column="marketing_agree"/>
        <result property="membershipGrade" column="membership_grade"/>

        <result property="role"
                column="role"
                javaType="com.carpick.domain.auth.entity.Role"/>

        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deletedAt" column="deleted_at"/>

    </resultMap>

    <!-- ===================== -->
    <!-- SELECT (ðŸ”¥ ëª…ì‹œ ì»¬ëŸ¼) -->
    <!-- ===================== -->

    <select id="existsByEmail" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE email = #{email}
        AND deleted_at IS NULL
    </select>

    <select id="findByEmail" resultMap="UserResultMap">
        SELECT
        user_id,
        email,
        password,
        provider,
        provider_id,
        name,
        phone,
        birth,
        gender,
        marketing_agree,
        membership_grade,
        role,
        created_at,
        updated_at,
        deleted_at
        FROM users
        WHERE email = #{email}
        AND deleted_at IS NULL
    </select>

    <select id="findByProvider" resultMap="UserResultMap">
        SELECT
        user_id,
        email,
        password,
        provider,
        provider_id,
        name,
        phone,
        birth,
        gender,
        marketing_agree,
        membership_grade,
        role,
        created_at,
        updated_at,
        deleted_at
        FROM users
        WHERE provider = #{provider}
        AND provider_id = #{providerId}
        AND deleted_at IS NULL
    </select>

    <select id="findById" resultMap="UserResultMap">
        SELECT
        user_id,
        email,
        password,
        provider,
        provider_id,
        name,
        phone,
        birth,
        gender,
        marketing_agree,
        membership_grade,
        role,
        created_at,
        updated_at,
        deleted_at
        FROM users
        WHERE user_id = #{userId}
        AND deleted_at IS NULL
    </select>

    <select id="findDeletedByProvider" resultMap="UserResultMap">
        SELECT
        user_id,
        email,
        password,
        provider,
        provider_id,
        name,
        phone,
        birth,
        gender,
        marketing_agree,
        membership_grade,
        role,
        created_at,
        updated_at,
        deleted_at
        FROM users
        WHERE provider = #{provider}
        AND provider_id = #{providerId}
        AND deleted_at IS NOT NULL
    </select>

    <!-- ===================== -->
    <!-- INSERT (ì¤‘ë³µ ë°©ì§€ ì¶”ê°€) -->
    <!-- ===================== -->

    <insert id="insertSocialUser"
            parameterType="com.carpick.domain.auth.entity.User"
            useGeneratedKeys="true"
            keyProperty="userId">

        INSERT INTO users (
        email,
        name,
        provider,
        provider_id,
        gender,
        marketing_agree,
        membership_grade,
        role
        )
        VALUES (
        #{email},
        #{name},
        #{provider},
        #{providerId},
        #{gender, typeHandler=com.carpick.global.mybatis.handler.GenderTypeHandler},
        #{marketingAgree},
        #{membershipGrade},
        #{role}
        )
    </insert>


    <!-- ===================== -->
    <!-- UPDATE -->
    <!-- ===================== -->

    <update id="updateUserInfo">
        UPDATE users
        SET
        name = #{name},
        phone = #{phone},
        birth = #{birth},
        gender = #{gender, typeHandler=com.carpick.global.mybatis.handler.GenderTypeHandler},
        marketing_agree = #{marketingAgree}
        WHERE user_id = #{userId}
        AND deleted_at IS NULL
    </update>
    <!-- ===================== -->
    <!-- ì†Œì…œ ê³„ì • ë³µêµ¬ -->
    <!-- ===================== -->
    <update id="reviveSocialUserBasic">
        UPDATE users
        SET
        email = #{email},
        name = #{name},
        deleted_at = NULL
        WHERE user_id = #{userId}
    </update>
    <!-- ===================== -->
    <!-- ì†Œì…œ ê³„ì • ì—°ë™ í•´ì œ = íšŒì› íƒˆí‡´ -->
    <!-- ===================== -->
    <update id="unlinkSocialAccount">
        UPDATE users
        SET
        deleted_at = CURRENT_TIMESTAMP
        WHERE user_id = #{userId}
        AND deleted_at IS NULL
    </update>


</mapper>