<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.carpick.admin.reservationAdmin.mapper.ReservationAdminMapper">

    <!-- =========================================================
         1) ÏÉÅÏÑ∏ Ï°∞Ìöå ResultMap (AdminReservationDetailDto Ï†ÑÏö©)
         - DTO ÌïÑÎìúÎ™ÖÏóê ÎßûÏ∂∞ alias/column Îß§Ìïë
         ========================================================= -->
    <resultMap id="AdminReservationDetailMap"
               type="com.carpick.admin.reservationAdmin.dto.AdminReservationDetailDto">

        <!-- 1Ô∏è‚É£ ÏòàÏïΩ ÏãùÎ≥Ñ -->
        <id     property="reservationId"  column="reservation_id"/>
        <result property="reservationNo"  column="reservation_no"/>

        <!-- 2Ô∏è‚É£ ÏòàÏïΩÏûê(USERS) -->
        <result property="userId"         column="user_id"/>
        <result property="name"           column="name"/>
        <result property="email"          column="email"/>

        <!-- 3Ô∏è‚É£ Ïö¥Ï†ÑÏûê(RESERVATION) -->
        <result property="driverLastName"   column="driver_last_name"/>
        <result property="driverFirstName"  column="driver_first_name"/>
        <result property="driverBirthdate"  column="driver_birthdate"/>
        <result property="driverPhone"      column="driver_phone"/>
        <result property="driverEmail"      column="driver_email"/>
        <result property="driverLicenseNo"  column="driver_license_no"/>

        <!-- 4Ô∏è‚É£ Ï∞®Îüâ(VEHICLE_INVENTORY + CAR_SPEC) -->
        <result property="vehicleId"        column="vehicle_id"/>
        <result property="brand"            column="brand"/>
        <result property="displayNameShort" column="display_name_short"/>
        <result property="modelName"        column="model_name"/>
        <result property="carNo"            column="vehicle_no"/>
        <result property="fuelType"         column="fuel_type"/>

        <!-- 5Ô∏è‚É£ ÏùºÏ†ï -->
        <result property="startDate"        column="start_date"/>
        <result property="endDate"          column="end_date"/>
        <result property="actualReturnDate" column="actual_return_date"/>

        <!-- 6Ô∏è‚É£ Ïù∏Ïàò/Î∞òÎÇ© -->
        <result property="pickupBranchId"   column="pickup_branch_id"/>
        <result property="pickupType"       column="pickup_type"/>
        <result property="pickupBranchName" column="pickup_branch_name"/>
        <result property="pickupAddress"    column="pickup_address"/>

        <result property="returnBranchId"   column="return_branch_id"/>
        <result property="returnType"       column="return_type"/>
        <result property="returnBranchName" column="return_branch_name"/>
        <result property="returnAddress"    column="return_address"/>

        <!-- 7Ô∏è‚É£ Î≥¥Ìóò/Ïø†Ìè∞ -->
        <result property="insuranceId"      column="insurance_id"/>
        <result property="insuranceLabel"   column="insurance_label"/>
        <result property="couponId"         column="coupon_id"/>
        <result property="couponName"       column="coupon_name"/>

        <!-- 8Ô∏è‚É£ Í∏àÏï° Ïä§ÎÉÖÏÉ∑ -->
        <result property="baseRentFeeSnapshot"             column="base_rent_fee_snapshot"/>
        <result property="rentDiscountAmountSnapshot"      column="rent_discount_amount_snapshot"/>
        <result property="baseInsuranceFeeSnapshot"        column="base_insurance_fee_snapshot"/>
        <result property="insuranceDiscountAmountSnapshot" column="insurance_discount_amount_snapshot"/>
        <result property="optionFeeSnapshot"               column="option_fee_snapshot"/>
        <result property="couponDiscountSnapshot"          column="coupon_discount_snapshot"/>
        <result property="eventDiscountAmountSnapshot"     column="event_discount_amount_snapshot"/>
        <result property="totalAmountSnapshot"             column="total_amount_snapshot"/>

        <!-- 9Ô∏è‚É£ ÏÉÅÌÉú/Ï∑®ÏÜå -->
        <result property="reservationStatus" column="reservation_status"/>
        <result property="cancelReason"      column="cancel_reason"/>
        <result property="cancelledAt"       column="cancelled_at"/>

        <!-- üîü Î©îÌÉÄ -->
        <result property="createdAt"         column="created_at"/>
        <result property="updatedAt"         column="updated_at"/>
    </resultMap>


    <!-- =========================================================
         2) Î™©Î°ù Í≥µÌÜµ Í≤ÄÏÉâ Ï°∞Í±¥
         - ReservationAdminMapper ÌååÎùºÎØ∏ÌÑ∞Î™Ö(fromDateTime/toDateTime/keyword/status) Í∏∞Ï§Ä
         ========================================================= -->
    <sql id="searchCondition">
        <where>
            <if test="status != null">
                r.reservation_status = #{status}
            </if>

            <if test="fromDateTime != null">
                AND r.start_date <![CDATA[>=]]> #{fromDateTime}
            </if>

            <if test="toDateTime != null">
                AND r.start_date <![CDATA[<=]]> #{toDateTime}
            </if>

            <if test="keyword != null and keyword != ''">
                AND (
                r.reservation_no LIKE CONCAT('%', #{keyword}, '%')
                OR u.name LIKE CONCAT('%', #{keyword}, '%')
                OR vi.vehicle_no LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
    </sql>


    <!-- =========================================================
         3) Î™©Î°ù Ï°∞Ìöå (ÌéòÏù¥Ïßï)
         - AdminReservationListDto ÌïÑÎìúÎ™Ö(reservationId,reservationNo,name,displayNameShort,carNo,startDate,endDate,totalAmountSnapshot,reservationStatus)
           Ïóê ÎßûÏ∂∞ alias ÏßÄÏ†ï
         ========================================================= -->
    <select id="selectReservationList"
            resultType="com.carpick.admin.reservationAdmin.dto.AdminReservationListDto">

        SELECT
        r.reservation_id        AS reservationId,
        r.reservation_no        AS reservationNo,
        u.name                  AS name,
        cs.display_name_short   AS displayNameShort,
        vi.vehicle_no           AS carNo,
        r.start_date            AS startDate,
        r.end_date              AS endDate,
        r.total_amount_snapshot AS totalAmountSnapshot,
        r.reservation_status    AS reservationStatus
        FROM RESERVATION r
        INNER JOIN USERS u              ON u.user_id = r.user_id
        INNER JOIN VEHICLE_INVENTORY vi ON vi.vehicle_id = r.vehicle_id
        INNER JOIN CAR_SPEC cs          ON cs.spec_id = vi.spec_id
        <include refid="searchCondition"/>
        ORDER BY r.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>


    <!-- =========================================================
         4) Î™©Î°ù COUNT (ÌéòÏù¥ÏßïÏö©)
         ========================================================= -->
    <select id="countReservationList" resultType="int">
        SELECT COUNT(1)
        FROM RESERVATION r
        INNER JOIN USERS u              ON u.user_id = r.user_id
        INNER JOIN VEHICLE_INVENTORY vi ON vi.vehicle_id = r.vehicle_id
        INNER JOIN CAR_SPEC cs          ON cs.spec_id = vi.spec_id
        <include refid="searchCondition"/>
    </select>


    <!-- =========================================================
         5) ÏÉÅÏÑ∏ Ï°∞Ìöå
         - ResultMapÍ≥º ÎèôÏùºÌïú column/aliasÎ•º Î∞òÌôò
         ========================================================= -->
    <select id="selectReservationDetail"
            resultMap="AdminReservationDetailMap">

        SELECT
            /* 1Ô∏è‚É£ ÏòàÏïΩ ÏãùÎ≥Ñ */
            r.reservation_id,
            r.reservation_no,

            /* 2Ô∏è‚É£ ÏòàÏïΩÏûê(USERS) */
            r.user_id,
            u.name  AS name,
            u.email AS email,

            /* 3Ô∏è‚É£ Ïö¥Ï†ÑÏûê(RESERVATION) */
            r.driver_last_name,
            r.driver_first_name,
            r.driver_birthdate,
            r.driver_phone,
            r.driver_email,
            r.driver_license_no,

            /* 4Ô∏è‚É£ Ï∞®Îüâ(VEHICLE_INVENTORY + CAR_SPEC) */
            r.vehicle_id,
            cs.brand,
            cs.display_name_short,
            cs.model_name,
            cs.fuel_type,
            vi.vehicle_no,

            /* 5Ô∏è‚É£ ÏùºÏ†ï */
            r.start_date,
            r.end_date,
            r.actual_return_date,

            /* 6Ô∏è‚É£ Ïù∏Ïàò */
            r.pickup_branch_id,
            r.pickup_type,
            pb.branch_name AS pickup_branch_name,
            r.pickup_address,

            /* 6Ô∏è‚É£ Î∞òÎÇ© */
            r.return_branch_id,
            r.return_type,
            rb.branch_name AS return_branch_name,
            r.return_address,

            /* 7Ô∏è‚É£ Î≥¥Ìóò/Ïø†Ìè∞ */
            r.insurance_id,
            ins.insurance_label,
            r.coupon_id,
            c.coupon_name,

            /* 8Ô∏è‚É£ Í∏àÏï° Ïä§ÎÉÖÏÉ∑ */
            r.base_rent_fee_snapshot,
            r.rent_discount_amount_snapshot,
            r.base_insurance_fee_snapshot,
            r.insurance_discount_amount_snapshot,
            r.option_fee_snapshot,
            r.coupon_discount_snapshot,
            r.event_discount_amount_snapshot,
            r.total_amount_snapshot,

            /* 9Ô∏è‚É£ ÏÉÅÌÉú/Ï∑®ÏÜå */
            r.reservation_status,
            r.cancel_reason,
            r.cancelled_at,

            /* üîü Î©îÌÉÄ */
            r.created_at,
            r.updated_at

        FROM RESERVATION r
                 INNER JOIN USERS u              ON u.user_id = r.user_id
                 INNER JOIN VEHICLE_INVENTORY vi ON vi.vehicle_id = r.vehicle_id
                 INNER JOIN CAR_SPEC cs          ON cs.spec_id = vi.spec_id
                 LEFT JOIN BRANCH pb             ON pb.branch_id = r.pickup_branch_id
                 LEFT JOIN BRANCH rb             ON rb.branch_id = r.return_branch_id
                 LEFT JOIN INSURANCE ins         ON ins.insurance_id = r.insurance_id
                 LEFT JOIN COUPON c              ON c.coupon_id = r.coupon_id
        WHERE r.reservation_id = #{reservationId}
    </select>

</mapper>
