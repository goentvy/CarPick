<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.carpick.admin.insuranceAdmin.mapper.AdminInsuranceMapper">

    <!--
            ResultMap: DB 컬럼명(snake_case) → DTO 필드명(camelCase) 매핑
            - insurance_id → insuranceId
            - insurance_code → insuranceCode  ✅ 수정
            - summary_label → summaryLabel
            - extra_daily_price → extraDailyPrice
        -->

    <resultMap id="AdminInsuranceResultMap" type="com.carpick.admin.insuranceAdmin.dto.AdminInsuranceDto">
        <id property="insuranceId" column="insurance_id"/>

        <result property="insuranceCode" column="insurance_code"/>

        <result property="label" column="label"/>
        <result property="summaryLabel" column="summary_label"/>
        <result property="extraDailyPrice" column="extra_daily_price"/>
        <result property="isDefault" column="is_default"/>
        <result property="isActive" column="is_active"/>
        <result property="sortOrder" column="sort_order"/>
        <result property="useYn" column="use_yn"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>
    <!--
           공통 컬럼 (SELECT용)
           - insurance_code로 수정 ✅
       -->


    <sql id="insertColumns">
        insurance_code, label, summary_label,
        extra_daily_price, is_default, is_active, sort_order,
        use_yn, created_at, updated_at
    </sql>



    <sql id="insertValues">
        #{insuranceCode}, #{label}, #{summaryLabel},
        #{extraDailyPrice}, #{isDefault}, #{isActive}, #{sortOrder},
        'Y', NOW(), NOW()
    </sql>



    <sql id="selectColumns">
        insurance_id, insurance_code, label, summary_label,
        extra_daily_price, is_default, is_active, sort_order,
        use_yn, updated_at
    </sql>

    <!--
          [목록 조회]
          - WHERE use_yn = 'Y': 삭제되지 않은 데이터만
          - ORDER BY sort_order ASC: 노출 순서대로 정렬
          - updated_at DESC: 같은 순서면 최근 수정된 것 먼저
      -->
    <select id="selectList" resultMap="AdminInsuranceResultMap">
        SELECT <include refid="selectColumns"/>
        FROM INSURANCE
        WHERE use_yn = 'Y'
        ORDER BY sort_order ASC, extra_daily_price ASC,updated_at DESC
    </select>
    <!--
           [단건 조회]
           - insuranceId로 1건 조회
           - use_yn = 'Y' 조건으로 삭제된 데이터 제외
       -->


    <select id="selectById" parameterType="long" resultMap="AdminInsuranceResultMap">
        SELECT <include refid="selectColumns"/>
        FROM INSURANCE
        WHERE insurance_id = #{insuranceId} AND use_yn = 'Y'
    </select>
    <!--
            [등록]
            - useGeneratedKeys="true": AUTO_INCREMENT로 생성된 PK를
            - keyProperty="insuranceId": dto.insuranceId에 자동 세팅
            - use_yn은 항상 'Y'로 등록 (신규는 삭제 상태 아님)
            - insurance_code로 수정 ✅
        -->


    <insert id="insert" parameterType="com.carpick.admin.insuranceAdmin.dto.AdminInsuranceDto"
            useGeneratedKeys="true" keyProperty="insuranceId">
        INSERT INTO INSURANCE (
        <include refid="insertColumns"/>
        ) VALUES (
        <include refid="insertValues"/>
        )
    </insert>

    <!--
      [수정]
      - WHERE에 use_yn = 'Y' 조건: 삭제된 데이터는 수정 불가
      - 반환값 int: 수정된 row 수 (정상이면 1, 없으면 0)
      - insurance_code로 수정 ✅
  -->

    <update id="update" parameterType="com.carpick.admin.insuranceAdmin.dto.AdminInsuranceDto">
        UPDATE INSURANCE
        SET
            insurance_code = #{insuranceCode},  label = #{label},
            summary_label = #{summaryLabel},
            extra_daily_price = #{extraDailyPrice},
            is_default = #{isDefault},
            is_active = #{isActive},
            sort_order = #{sortOrder},
            updated_at = NOW()
        WHERE insurance_id = #{insuranceId} AND use_yn = 'Y'
    </update>
    <!--
            [Soft Delete - 논리 삭제]
            - 실제 DELETE 대신 UPDATE로 처리
            - use_yn = 'N': 삭제된 것으로 표시
            - deleted_at = NOW(): 삭제 시점 기록 (추후 복구/이력 추적용)
            - 반환값 int: 삭제된 row 수
        -->


    <update id="softDelete" parameterType="long">
        UPDATE INSURANCE
        SET use_yn = 'N', deleted_at = NOW()
        WHERE insurance_id = #{insuranceId}
    </update>

    <select id="selectDeletedByCode"
            resultMap="AdminInsuranceResultMap"
            parameterType="com.carpick.domain.insurance.enums.InsuranceCode">

        SELECT <include refid="selectColumns"/>
        FROM INSURANCE
        WHERE insurance_code = #{insuranceCode}
        AND use_yn = 'N'
    </select>
    <!--
          [복구]
          - Soft Delete된 데이터를 다시 살림
          - use_yn = 'Y': 정상 상태로 복구
          - deleted_at = NULL: 삭제 시점 초기화
          - 반환값 int: 복구된 row 수
      -->


    <update id="restore" parameterType="long">
        UPDATE INSURANCE
        SET use_yn = 'Y', deleted_at = NULL
        WHERE insurance_id = #{insuranceId}
    </update>

    <!--
        [참조 체크 - 예약 테이블]
        - 목적: 삭제 전 참조 무결성 확인
        - 이 보험을 사용 중인 예약이 있으면 삭제 불가
        - COUNT(*) > 0 이면 → "이 보험을 사용 중인 예약이 N건 있습니다" 에러

        ⚠️ 주의: RESERVATION 테이블에 use_yn 컬럼 없으면
                AND use_yn = 'Y' 조건 제거할 것
    -->

    <select id="countReservationByInsuranceId" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM RESERVATION
        WHERE insurance_id = #{insuranceId}
    </select>

</mapper>