<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.carpick.domain.car.mapper.CarMapper" >
    <!--resultMapì€ í˜„ì œ ì»¬ëŸ¼ëª…ì´ ê°™ì•„ì„œ ì“¸í•„ìš” ì—†ìŒ-->
    <!--    ì°¨ëŸ‰ìƒì„¸ì¡°íšŒ ì»¬ë ´ ë¬¶ìŒ-->
<!--    <sql id="carColumns">-->
<!--        vi.vehicle_id       AS vehicleId,-->
<!--    cs.brand            AS brand,-->
<!--    cs.model_name       AS modelName,-->
<!--    cs.car_class        AS carClass,-->
<!--    cs.fuel_type        AS fuelType,-->
<!--    cs.seating_capacity AS seatingCapacity,-->
<!--&#45;&#45;     cs.main_image_url   AS mainImageUrl,-->
<!--    p.standard_price    AS standardPrice,-->
<!--    b.branch_name       AS branchName,-->
<!--    vi.status           AS status-->



<!--    </sql>-->

<!--    <sql id="carDetailExtraColumns">-->
<!--        cs.trunk_capacity   AS trunkCapacity,-->
<!--    cs.fuel_efficiency  AS fuelEfficiency,-->
<!--    vi.model_year       AS modelYear,-->
<!--    b.address_basic     AS addressBasic-->

<!--    </sql>-->

    <!-- AI ì¶”ì²œìš©: ì°¨ì¢…ë³„ ì¹´ë“œ ëª©ë¡ -->
    <select id="selectCarCardByCarClass" resultType="com.carpick.domain.aipick.dto.AiCarCardDto">
        SELECT
            vi.vehicle_id        AS vehicleId,
            cs.spec_id           AS specId,
            cs.display_name_short AS displayNameShort,
            cs.brand             AS brand,
            cs.ai_summary        AS aiSummary,
            cs.img_url    AS imgUrl,
            cs.drive_labels      AS driveLabels,
            pp.base_price        AS basePrice,
            pp.discount_rate     AS discountRate,
            ROUND(pp.base_price * (1 - pp.discount_rate / 100)) AS finalPrice
        FROM VEHICLE_INVENTORY vi
                 INNER JOIN CAR_SPEC cs ON cs.spec_id = vi.spec_id
                 LEFT JOIN PRICE_POLICY pp
                           ON pp.spec_id = cs.spec_id
                               AND pp.branch_id = vi.branch_id
                               AND pp.is_active = TRUE
                               AND pp.price_type = 'DAILY'
                               AND pp.use_yn = 'Y'

        WHERE vi.operational_status = 'AVAILABLE'
          AND vi.use_yn = 'Y'
          AND cs.use_yn = 'Y'
          AND cs.car_class = #{carClass}
        ORDER BY pp.base_price ASC
    </select>

    <!-- AI ì¶”ì²œìš©: ì°¨ì¢…ë³„ ì°¨ëŸ‰ ëª©ë¡ -->
    <select id="selectCarListByCarClass" resultType="com.carpick.domain.car.dto.CarListDto">
        SELECT
            vi.vehicle_id       AS vehicleId,
            cs.display_name_short AS displayNameShort,
            cs.brand            AS brand,
            cs.car_class        AS carClass,
            cs.fuel_type        AS fuelType,
            cs.main_image_url   AS mainImageUrl,
            pp.base_price       AS basePrice,
            pp.discount_rate    AS discountRate
        FROM VEHICLE_INVENTORY vi
                 INNER JOIN CAR_SPEC cs ON cs.spec_id = vi.spec_id
                 LEFT JOIN PRICE_POLICY pp
                           ON pp.spec_id = cs.spec_id
                               AND pp.branch_id = vi.branch_id
                               AND pp.is_active = TRUE
                               AND pp.price_type = 'DAILY'
                               AND pp.use_yn = 'Y'

        WHERE vi.operational_status = 'AVAILABLE'
          AND vi.use_yn = 'Y'
          AND cs.use_yn = 'Y'
          AND cs.car_class = #{carClass}
        ORDER BY pp.base_price ASC
    </select>

    <!-- ì°¨ëŸ‰ ìƒì„¸ ì •ë³´ ì¡°íšŒ -->
    <select id="selectCarDetail" parameterType="Long" resultType="com.carpick.domain.car.dto.raw.CarDetailRawDto">
        SELECT
            /* CAR_SPEC */
            cs.spec_id            AS specId,
            cs.model_name         AS modelName,
            cs.display_name_short AS displayNameShort,
            cs.car_class          AS carClass,
            cs.fuel_type          AS fuelType,
            cs.seating_capacity   AS seatingCapacity,
            cs.model_year_base    AS modelYearBase,
            cs.main_video_url     AS mainVideoUrl,
            cs.min_driver_age     AS minDriverAge,
            cs.min_license_years  AS minLicenseYears,
            cs.fuel_efficiency    AS fuelEfficiency,

            /* BRANCH (ë‹¤ì´ì–´íŠ¸: ëŒ€í‘œ ì§€ì  1ê°œë§Œ ë¶™ì„ - ê°€ê²©ì •ì±…ì˜ branch ê¸°ì¤€) */
            b.branch_id           AS branchId,
            b.branch_name         AS branchName,
            b.address_basic       AS addressBasic,
            b.latitude            AS latitude,
            b.longitude           AS longitude,
            b.open_time           AS openTime,
            b.close_time          AS closeTime,

            /* PRICE_POLICY (DAILY) */
            pp.base_price         AS dailyPrice,
            pp.discount_rate      AS discountRate

        FROM CAR_SPEC cs
                 /* ê°€ê²©ì •ì±…ì´ ìˆì–´ì•¼ branchë¥¼ ì•Œ ìˆ˜ ìˆìœ¼ë‹ˆ PRICE_POLICYë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì¸ */
                 LEFT JOIN PRICE_POLICY pp
                           ON pp.spec_id = cs.spec_id
                               AND pp.price_type = 'DAILY'
                               AND pp.is_active = TRUE
                               AND pp.use_yn = 'Y'

                 LEFT JOIN BRANCH b
                           ON b.branch_id = pp.branch_id

        WHERE cs.spec_id = #{specId}
          AND cs.use_yn = 'Y'

        /* branch_idê°€ ìˆëŠ” ì •ì±…ì„ ìš°ì„  + ìµœì‹  valid_from ìš°ì„  */
        ORDER BY (pp.branch_id IS NULL) ASC, pp.valid_from DESC
            LIMIT 1
    </select>

    <!-- ì°¨ëŸ‰ ìƒì„¸ ì •ë³´ ì¡°íšŒ V2 (ìŠ¤í™ ì¤‘ì‹¬ + ì„ íƒ ì§€ì  ì»¨í…ìŠ¤íŠ¸) -->
    <select id="selectCarDetailV2"
            parameterType="map"
            resultType="com.carpick.domain.car.dto.raw.CarDetailRawDto">

        SELECT
            /* CAR_SPEC */
            cs.spec_id            AS specId,
            cs.model_name         AS modelName,
            cs.car_class          AS carClass,
            cs.fuel_type          AS fuelType,
            cs.seating_capacity   AS seatingCapacity,
            cs.model_year_base    AS modelYearBase,
            cs.main_video_url     AS mainVideoUrl,
            cs.min_driver_age     AS minDriverAge,
            cs.min_license_years  AS minLicenseYears,
            cs.fuel_efficiency    AS fuelEfficiency,
            cs.ai_summary         AS aiSummary,
            cs.car_options        AS carOptions,
            /* BRANCH (ì‚¬ìš©ì ì„ íƒ pickupBranchId) */
            b.branch_id           AS branchId,
            b.branch_name         AS branchName,
            b.address_basic       AS addressBasic,
            b.latitude            AS latitude,
            b.longitude           AS longitude,
            b.open_time           AS openTime,
            b.close_time          AS closeTime

        FROM CAR_SPEC cs
                 JOIN BRANCH b
                      ON b.branch_id = #{pickupBranchId}
                          AND b.use_yn = 'Y'

        WHERE cs.spec_id = #{specId}
          AND cs.use_yn = 'Y'
    </select>

    <!--ì°¨ëŸ‰ ëª©ë¡ í˜ì´ì§€ ì¿¼ë¦¬ -->
    <select id="selectCarListItems"
            resultType="com.carpick.domain.car.dto.carListPage.CarListItemDto">

        SELECT
            /*  ëŒ€í‘œ ì‹¤ì°¨ ID (ìƒì„¸/ì˜ˆì•½ ì—°ê²°ìš©: ê°€ì¥ ë¹ ë¥¸ ë²ˆí˜¸ 1ê°œ) */
            MIN(vi.vehicle_id)           AS vehicleId,

            /* ì°¨ì¢…(ìŠ¤í™) ì •ë³´ */
            cs.spec_id                   AS specId,
            cs.display_name_short        AS displayNameShort,
            cs.img_url            AS imgUrl,
            cs.model_year_base           AS modelYear,
            cs.seating_capacity          AS seatingCapacity,
            cs.drive_labels              AS driveLabels,

            /* ê°€ê²©(í‘œì‹œìš©, optional) */
            p.daily_price                AS originalPrice,

            /* ğŸ”¥ [ìˆ˜ì •] ì •ì±…ì´ ì—¬ëŸ¬ ê°œ ê²¹ì¹  ê²½ìš°, ê°€ì¥ ë†’ì€ í• ì¸ìœ¨ ì ìš© (ì•ˆì „ì¥ì¹˜) */
            MAX(pp.discount_rate)        AS discountRate,

            /* ìµœì¢…ê°€ (ë°±ì—”ë“œ ê¸°ì¤€ê°’) */
            /* MAX(pp.discount_rate)ë¥¼ ë°˜ì˜í•˜ì—¬ ê³„ì‚°ì‹ë„ ì‚´ì§ ìˆ˜ì •ë¨ */
            CASE
                WHEN p.daily_price IS NULL THEN 0
                WHEN MAX(pp.discount_rate) IS NULL THEN p.daily_price
                ELSE FLOOR(p.daily_price * (1 - (MAX(pp.discount_rate) / 100.0)))
                END                          AS finalPrice

        FROM CAR_SPEC cs

                 /* ğŸ” ì‹¤ì°¨ëŠ” "ì¡´ì¬ ì—¬ë¶€" íŒë‹¨ìš© (ì¬ê³  ì—†ìœ¼ë©´ ì•ˆ ë‚˜ì˜´) */
                 JOIN VEHICLE_INVENTORY vi
                      ON vi.spec_id = cs.spec_id
                          AND vi.is_active = TRUE
                          AND vi.use_yn = 'Y'
                          AND vi.operational_status = 'AVAILABLE'
/* ğŸ”¥ [ì¶”ê°€] í”„ëŸ°íŠ¸ URLì—ì„œ ë„˜ì–´ì˜¨ ì§€ì  IDë¡œ í•„í„°ë§ */
                          AND vi.branch_id = #{pickupBranchId}
            /* ì›ê°€ */
                 LEFT JOIN PRICE p
                           ON p.car_spec_id = cs.spec_id
                               AND p.use_yn = 'Y'
                               AND p.deleted_at IS NULL

            /* í• ì¸ ì •ì±… */
                 LEFT JOIN PRICE_POLICY pp
                           ON pp.spec_id = cs.spec_id
                               AND pp.is_active = TRUE

        WHERE cs.use_yn = 'Y'

        /* ğŸ”¥ GROUP BY: ì§‘ê³„ í•¨ìˆ˜(MIN, MAX)ë¥¼ ì œì™¸í•œ ëª¨ë“  ì»¬ëŸ¼ ëª…ì‹œ (SQL í‘œì¤€ ì¤€ìˆ˜) */
        GROUP BY
            cs.spec_id,
            cs.display_name_short,
            cs.img_url,
            cs.model_year_base,
            cs.seating_capacity,
            cs.drive_labels,
            p.daily_price
        /* pp.discount_rateëŠ” ì§‘ê³„í•¨ìˆ˜(MAX) ì¼ìœ¼ë¯€ë¡œ ê·¸ë£¹ë°”ì´ì—ì„œ ëºŒ */

        ORDER BY cs.spec_id DESC
    </select>

</mapper>