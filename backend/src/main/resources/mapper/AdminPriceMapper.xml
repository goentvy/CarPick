<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.carpick.admin.priceAdmin.mapper.AdminPriceMapper">

    <!-- ===================== ResultMap ===================== -->
    <resultMap id="AdminPriceResultMap"
               type="com.carpick.admin.priceAdmin.dto.AdminPriceDto">

        <!-- PK -->
        <id     property="priceId"     column="price_id"/>

        <!-- FK (CAR_SPEC) -->
        <result property="specId"   column="spec_id"/>

        <!-- 차종 정보 -->
        <result property="brand"       column="brand"/>
        <result property="modelName"   column="model_name"/>

        <!-- 원가 -->
        <result property="dailyPrice"  column="daily_price"/>
        <result property="monthlyPrice" column="monthly_price"/>

        <!-- 낙관적 락 -->
        <result property="version"     column="version"/>

        <!-- 운영 상태 -->
        <result property="useYn"       column="use_yn"/>
        <result property="deletedAt"   column="deleted_at"/>
        <result property="updatedAt"   column="updated_at"/>
    </resultMap>


    <!-- ===================== 공통 SELECT 컬럼 ===================== -->
    <sql id="selectColumns">
        p.price_id,
        p.spec_id,
        s.brand,
        s.model_name,
        p.daily_price,
        p.monthly_price,
        p.version,
        p.use_yn,
        p.deleted_at,
        p.updated_at
    </sql>


    <!-- ===================== [1] 전체 목록 조회 ===================== -->
    <select id="selectList" resultMap="AdminPriceResultMap">
        SELECT
        <include refid="selectColumns"/>
        FROM price p
        JOIN car_spec s
        ON s.spec_id = p.spec_id


        ORDER BY s.brand, s.model_name
    </select>


    <!-- ===================== [2] 단건 조회 ===================== -->
    <select id="selectBySpecId"
            parameterType="long"
            resultMap="AdminPriceResultMap">
        SELECT
        <include refid="selectColumns"/>
        FROM price p
        JOIN car_spec s
        ON s.spec_id = p.spec_id
        WHERE p.spec_id = #{specId}

        AND p.deleted_at IS NULL
        LIMIT 1
    </select>


    <!-- ===================== [4] 가격 수정 (낙관적 락 적용) ===================== -->
    <update id="updatePriceWithVersion"
            parameterType="com.carpick.admin.priceAdmin.dto.AdminPriceDto">
        UPDATE price
        SET
            daily_price   = #{dailyPrice},
            monthly_price = #{monthlyPrice},
            updated_at    = NOW(),
            version       = version + 1
        WHERE price_id = #{priceId}
          AND version  = #{version}

          AND deleted_at IS NULL
    </update>


    <!-- ===================== [5] 기본 가격 신규 등록 (Insert) ===================== -->
    <insert id="insertPrice"
            parameterType="com.carpick.admin.priceAdmin.dto.AdminPriceDto"
            useGeneratedKeys="true"
            keyProperty="priceId">
        INSERT INTO price (
            spec_id,
            daily_price,
            monthly_price,

            deleted_at,
            version,
            created_at,
            updated_at
        ) VALUES (
                     #{specId},
                     IFNULL(#{dailyPrice}, 0),
                     IFNULL(#{monthlyPrice}, 0),

                     NULL,
                     0,
                     NOW(),
                     NOW()
                 )
    </insert>
    <!-- ===================== [6] 논리 삭제 (긴급 비활성화) ===================== -->
    <update id="softDeletePrice">
        UPDATE price
        SET
            use_yn     = 'N',

            version    = version + 1,
            updated_at = NOW()
        WHERE price_id = #{priceId}
          AND version = #{version}
          AND use_yn = 'Y'
    </update>


    <!-- ===================== [7] 복구 (재활성화) ===================== -->
    <update id="restorePrice">
        UPDATE price
        SET
            use_yn     = 'Y',
            deleted_at = NULL,
            version    = version + 1,
            updated_at = NOW()
        WHERE price_id = #{priceId}
          AND version = #{version}
          AND use_yn = 'N'
    </update>
</mapper>
